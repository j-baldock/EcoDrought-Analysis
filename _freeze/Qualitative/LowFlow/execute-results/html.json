{
  "hash": "3d1f1388e570b7cbb11134881b3ac5e5",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Low Flow Variation\"\n---\n\n\n\n\n\n\n\n\n\n**Purpose:** Evaluate spatiotemporal variation in drought-related low flow conditions across headwater stream networks. \n\n**Approach:**\n\n* Derive reference (\"fixed\" thresholds from reference/Big G gages) and site-specific low flow thresholds from contemporary data (*sensu* Hammond *et al.* 2022). \n* Use heatmaps to show how the duration and severity of low flow conditions varies among headwater locations and relative to big G.\n* Use scatterplots to quantify the effect of regional water availability on spatial heterogeneity in drought-related low flow conditions. \n* Explore how the effect size changes depending on the magnitude of the low flow threshold used.\n\n\n## Data\n\nSite information\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsiteinfo <- read_csv(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/Data/EcoDrought_SiteInformation.csv\")\nsiteinfo_sp <- st_as_sf(siteinfo, coords = c(\"long\", \"lat\"), crs = 4326)\n```\n:::\n\n\n\n\n\n\nLittle g's\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat_clean <- read_csv(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/LittleG_data_clean.csv\")\n```\n:::\n\n\n\n\n\n\nBig G's\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat_clean_big <- read_csv(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/BigG_data_clean.csv\")\n```\n:::\n\n\n\n\n\n\nClimate\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclimdf <- read_csv(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/Daymet_climate.csv\")\nclimdf_summ <- read_csv(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/Daymet_climate_summary.csv\")\n```\n:::\n\n\n\n\n\n\nWater availability\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# wateravail <- read_csv(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/BigG_wateravailability_annual.csv\")\nwateravail <- read_csv(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/BigG_wateravailability_annual.csv\") %>%\n  filter(!is.na(totalyield), !is.na(totalyield_sum)) %>%\n  group_by(site_name) %>%\n  mutate(tyz_perc = percentile(totalyield_z),\n         tyz_sum_perc = percentile(totalyield_sum_z)) %>%\n  mutate(tyz_perc = ifelse(is.na(tyz_perc), 0, tyz_perc),\n         tyz_sum_perc = ifelse(is.na(tyz_sum_perc), 0, tyz_sum_perc)) %>%\n  ungroup()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# get range of years for little g data\ndaterange <- dat_clean %>% group_by(basin) %>% summarize(minyear = year(min(date)), maxyear = year(max(date)))\n\n# spread ecod years\nmylist <- vector(\"list\", length = dim(daterange)[1])\nfor (i in 1:dim(daterange)[1]) {\n  mylist[[i]] <- tibble(basin = daterange$basin[i], WaterYear = seq(from = daterange$minyear[i], to = daterange$maxyear[i], by = 1))\n}\nyrdf <- do.call(rbind, mylist) %>% mutate(ecodyr = \"yes\")\n```\n:::\n\n\n\n\n\n\n\n## Order sites\n\nFor colors, order sites from downstream to upstream (roughly) and by subbasin (if appropriate)\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwborder <- c(\"West Brook NWIS\", \"West Brook Lower\", \"Mitchell Brook\", \"Jimmy Brook\", \"Obear Brook Lower\", \"West Brook Upper\", \"West Brook Reservoir\", \"Sanderson Brook\", \"Avery Brook\", \"West Whately Brook\")\npaineorder <- c(\"Paine Run 10\", \"Paine Run 08\", \"Paine Run 07\", \"Paine Run 06\", \"Paine Run 02\", \"Paine Run 01\")\nstauntorder <- c(\"Staunton River 10\", \"Staunton River 09\", \"Staunton River 07\", \"Staunton River 06\", \"Staunton River 03\", \"Staunton River 02\")\nflatorder <- c(\"BigCreekLower\", \"LangfordCreekLower\", \"LangfordCreekUpper\", \"Big Creek NWIS\", \"BigCreekUpper\", \"HallowattCreekLower\", \"NicolaCreek\", \"WernerCreek\", \"Hallowat Creek NWIS\", \"CoalCreekLower\", \"CycloneCreekLower\", \"CycloneCreekMiddle\", \"CycloneCreekUpper\", \"CoalCreekMiddle\", \"CoalCreekNorth\", \"CoalCreekHeadwaters\", \"McGeeCreekLower\", \"McGeeCreekTrib\", \"McGeeCreekUpper\")\nyellorder <- c(\"Shields River Valley Ranch\", \"Deep Creek\", \"Crandall Creek\", \"Buck Creek\", \"Dugout Creek\", \"Shields River ab Dugout\", \"Lodgepole Creek\", \"EF Duck Creek be HF\", \"EF Duck Creek ab HF\", \"Henrys Fork\")\nsnakeorder <- c(\"Spread Creek Dam\", \"Rock Creek\", \"NF Spread Creek Lower\", \"NF Spread Creek Upper\", \"Grizzly Creek\", \"SF Spread Creek Lower\", \"Grouse Creek\", \"SF Spread Creek Upper\", \"Leidy Creek Mouth\")\ndonnerorder <- c(\"Fish Creek NWIS\", \"Donner Blitzen ab Fish NWIS\", \"Donner Blitzen nr Burnt Car NWIS\", \"Donner Blitzen ab Indian NWIS\")\n```\n:::\n\n\n\n\n\n\n\n## Low flow thresholds\n\n### Basin scale\n\nGenerate fixed and time varying (by day of year) drought/low flow thresholds from long-term (1970-2025) big G streamflow data. Quantiles in ~0.05 increments from 0.02 to 0.50. \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# calculate site-level fixed low flow thresholds\ndat_clean_big_fixed <- dat_clean_big %>% \n  filter(!is.na(basin)) %>%\n  group_by(site_name, basin, subbasin, region) %>%\n  summarize(thresh_50_fix = quantile(Yield_mm, probs = 0.50, na.rm = TRUE),\n            thresh_45_fix = quantile(Yield_mm, probs = 0.45, na.rm = TRUE),\n            thresh_40_fix = quantile(Yield_mm, probs = 0.40, na.rm = TRUE),\n            thresh_35_fix = quantile(Yield_mm, probs = 0.35, na.rm = TRUE),\n            thresh_30_fix = quantile(Yield_mm, probs = 0.30, na.rm = TRUE),\n            thresh_25_fix = quantile(Yield_mm, probs = 0.25, na.rm = TRUE),\n            thresh_20_fix = quantile(Yield_mm, probs = 0.20, na.rm = TRUE),\n            thresh_15_fix = quantile(Yield_mm, probs = 0.15, na.rm = TRUE),\n            thresh_10_fix = quantile(Yield_mm, probs = 0.10, na.rm = TRUE),\n            thresh_05_fix = quantile(Yield_mm, probs = 0.05, na.rm = TRUE),\n            thresh_02_fix = quantile(Yield_mm, probs = 0.02, na.rm = TRUE)) %>%\n  ungroup()\n(dat_clean_big_fixed)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 8 × 15\n  site_name      basin subbasin region thresh_50_fix thresh_45_fix thresh_40_fix\n  <chr>          <chr> <chr>    <chr>          <dbl>         <dbl>         <dbl>\n1 Battle Run NW… Pine… Piney R… Shen           0.586         0.513         0.439\n2 Donner Blitze… Donn… Donner … Oreg           0.272         0.246         0.227\n3 North Fork Fl… Flat… Flathead Flat           0.729         0.644         0.579\n4 Pacific Creek… Snak… Snake R… Snake          0.364         0.336         0.313\n5 Rapidan River… Stau… Staunto… Shen           0.830         0.731         0.642\n6 South River C… West… West Br… Mass           1.34          1.18          1.02 \n7 South River H… Pain… Paine R… Shen           0.704         0.624         0.557\n8 Yellowstone R… Shie… Shields… Shiel…         0.500         0.466         0.438\n# ℹ 8 more variables: thresh_35_fix <dbl>, thresh_30_fix <dbl>,\n#   thresh_25_fix <dbl>, thresh_20_fix <dbl>, thresh_15_fix <dbl>,\n#   thresh_10_fix <dbl>, thresh_05_fix <dbl>, thresh_02_fix <dbl>\n```\n\n\n:::\n\n```{.r .cell-code}\n# calculate site-level variable (by doy) low flow thresholds\ndat_clean_big_variable <- dat_clean_big %>% \n  filter(!is.na(basin)) %>%\n  group_by(site_name, basin, subbasin, region, doy_calendar) %>%\n  summarize(thresh_50_var = quantile(Yield_mm, probs = 0.50, na.rm = TRUE),\n            thresh_45_var = quantile(Yield_mm, probs = 0.45, na.rm = TRUE),\n            thresh_40_var = quantile(Yield_mm, probs = 0.40, na.rm = TRUE),\n            thresh_35_var = quantile(Yield_mm, probs = 0.35, na.rm = TRUE),\n            thresh_30_var = quantile(Yield_mm, probs = 0.30, na.rm = TRUE),\n            thresh_25_var = quantile(Yield_mm, probs = 0.25, na.rm = TRUE),\n            thresh_20_var = quantile(Yield_mm, probs = 0.20, na.rm = TRUE),\n            thresh_15_var = quantile(Yield_mm, probs = 0.15, na.rm = TRUE),\n            thresh_10_var = quantile(Yield_mm, probs = 0.10, na.rm = TRUE),\n            thresh_05_var = quantile(Yield_mm, probs = 0.05, na.rm = TRUE),\n            thresh_02_var = quantile(Yield_mm, probs = 0.02, na.rm = TRUE)) %>%\n  ungroup()\n(dat_clean_big_variable)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2,928 × 16\n   site_name      basin subbasin region doy_calendar thresh_50_var thresh_45_var\n   <chr>          <chr> <chr>    <chr>         <dbl>         <dbl>         <dbl>\n 1 Battle Run NW… Pine… Piney R… Shen              1         0.732         0.687\n 2 Battle Run NW… Pine… Piney R… Shen              2         0.754         0.702\n 3 Battle Run NW… Pine… Piney R… Shen              3         0.815         0.727\n 4 Battle Run NW… Pine… Piney R… Shen              4         0.860         0.802\n 5 Battle Run NW… Pine… Piney R… Shen              5         0.805         0.732\n 6 Battle Run NW… Pine… Piney R… Shen              6         0.751         0.690\n 7 Battle Run NW… Pine… Piney R… Shen              7         0.859         0.790\n 8 Battle Run NW… Pine… Piney R… Shen              8         0.787         0.732\n 9 Battle Run NW… Pine… Piney R… Shen              9         0.805         0.784\n10 Battle Run NW… Pine… Piney R… Shen             10         0.820         0.732\n# ℹ 2,918 more rows\n# ℹ 9 more variables: thresh_40_var <dbl>, thresh_35_var <dbl>,\n#   thresh_30_var <dbl>, thresh_25_var <dbl>, thresh_20_var <dbl>,\n#   thresh_15_var <dbl>, thresh_10_var <dbl>, thresh_05_var <dbl>,\n#   thresh_02_var <dbl>\n```\n\n\n:::\n:::\n\n\n\n\n\n\nJoin drought thresholds derived from big G to little g's\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmydroughtlevels <- c(\"none\", \"q50\", \"q45\", \"q40\", \"q35\", \"q30\", \"q25\", \"q20\", \"q15\", \"q10\", \"q05\", \"q02\")\n\n# little gs\ndat_clean_little_join <- dat_clean %>% \n  left_join(dat_clean_big_fixed %>% select(-c(site_name, subbasin))) %>%\n  left_join(dat_clean_big_variable %>% select(-c(site_name, subbasin))) %>%\n  mutate(month = month(date),\n         year = year(date),\n         designation = \"little\",\n         drought_fix = ifelse(Yield_mm <= thresh_50_fix & Yield_mm > thresh_45_fix, \"q50\",\n                              ifelse(Yield_mm <= thresh_45_fix & Yield_mm > thresh_40_fix, \"q45\",\n                                     ifelse(Yield_mm <= thresh_40_fix & Yield_mm > thresh_35_fix, \"q40\",\n                                            ifelse(Yield_mm <= thresh_35_fix & Yield_mm > thresh_30_fix, \"q35\",\n                                                   ifelse(Yield_mm <= thresh_30_fix & Yield_mm > thresh_25_fix, \"q30\",\n                                                          ifelse(Yield_mm <= thresh_25_fix & Yield_mm > thresh_20_fix, \"q25\",\n                                                                 ifelse(Yield_mm <= thresh_20_fix & Yield_mm > thresh_15_fix, \"q20\",\n                                                                        ifelse(Yield_mm <= thresh_15_fix & Yield_mm > thresh_10_fix, \"q15\",\n                                                                               ifelse(Yield_mm <= thresh_10_fix & Yield_mm > thresh_05_fix, \"q10\",\n                                                                                      ifelse(Yield_mm <= thresh_05_fix & Yield_mm > thresh_02_fix, \"q05\",  \n                                                                                             ifelse(Yield_mm <= thresh_02_fix, \"q02\", \"none\"))))))))))),\n         drought_var = ifelse(Yield_mm <= thresh_50_var & Yield_mm > thresh_45_var, \"q50\",\n                              ifelse(Yield_mm <= thresh_45_var & Yield_mm > thresh_40_var, \"q45\",\n                                     ifelse(Yield_mm <= thresh_40_var & Yield_mm > thresh_35_var, \"q40\",\n                                            ifelse(Yield_mm <= thresh_35_var & Yield_mm > thresh_30_var, \"q35\",\n                                                   ifelse(Yield_mm <= thresh_30_var & Yield_mm > thresh_25_var, \"q30\",\n                                                          ifelse(Yield_mm <= thresh_25_var & Yield_mm > thresh_20_var, \"q25\",\n                                                                 ifelse(Yield_mm <= thresh_20_var & Yield_mm > thresh_15_var, \"q20\",\n                                                                        ifelse(Yield_mm <= thresh_15_var & Yield_mm > thresh_10_var, \"q15\",\n                                                                               ifelse(Yield_mm <= thresh_10_var & Yield_mm > thresh_05_var, \"q10\",\n                                                                                      ifelse(Yield_mm <= thresh_05_var & Yield_mm > thresh_02_var, \"q05\", \n                                                                                             ifelse(Yield_mm <= thresh_02_var, \"q02\", \"none\")))))))))))) %>%\n  mutate(drought_fix = factor(ifelse(is.na(Yield_mm), NA, drought_fix), levels = mydroughtlevels),\n         drought_var = factor(ifelse(is.na(Yield_mm), NA, drought_var), levels = mydroughtlevels)) \n\n# big gs\ndat_clean_big_join <- dat_clean_big %>% \n  left_join(dat_clean_big_fixed %>% select(-c(site_name, subbasin))) %>%\n  left_join(dat_clean_big_variable %>% select(-c(site_name, subbasin))) %>%\n  mutate(month = month(date),\n         year = year(date),\n         designation = \"big\",\n         drought_fix = ifelse(Yield_mm <= thresh_50_fix & Yield_mm > thresh_45_fix, \"q50\",\n                              ifelse(Yield_mm <= thresh_45_fix & Yield_mm > thresh_40_fix, \"q45\",\n                                     ifelse(Yield_mm <= thresh_40_fix & Yield_mm > thresh_35_fix, \"q40\",\n                                            ifelse(Yield_mm <= thresh_35_fix & Yield_mm > thresh_30_fix, \"q35\",\n                                                   ifelse(Yield_mm <= thresh_30_fix & Yield_mm > thresh_25_fix, \"q30\",\n                                                          ifelse(Yield_mm <= thresh_25_fix & Yield_mm > thresh_20_fix, \"q25\",\n                                                                 ifelse(Yield_mm <= thresh_20_fix & Yield_mm > thresh_15_fix, \"q20\",\n                                                                        ifelse(Yield_mm <= thresh_15_fix & Yield_mm > thresh_10_fix, \"q15\",\n                                                                               ifelse(Yield_mm <= thresh_10_fix & Yield_mm > thresh_05_fix, \"q10\",\n                                                                                      ifelse(Yield_mm <= thresh_05_fix & Yield_mm > thresh_02_fix, \"q05\", \n                                                                                             ifelse(Yield_mm <= thresh_02_fix, \"q02\", \"none\"))))))))))),\n         drought_var = ifelse(Yield_mm <= thresh_50_var & Yield_mm > thresh_45_var, \"q50\",\n                              ifelse(Yield_mm <= thresh_45_var & Yield_mm > thresh_40_var, \"q45\",\n                                     ifelse(Yield_mm <= thresh_40_var & Yield_mm > thresh_35_var, \"q40\",\n                                            ifelse(Yield_mm <= thresh_35_var & Yield_mm > thresh_30_var, \"q35\",\n                                                   ifelse(Yield_mm <= thresh_30_var & Yield_mm > thresh_25_var, \"q30\",\n                                                          ifelse(Yield_mm <= thresh_25_var & Yield_mm > thresh_20_var, \"q25\",\n                                                                 ifelse(Yield_mm <= thresh_20_var & Yield_mm > thresh_15_var, \"q20\",\n                                                                        ifelse(Yield_mm <= thresh_15_var & Yield_mm > thresh_10_var, \"q15\",\n                                                                               ifelse(Yield_mm <= thresh_10_var & Yield_mm > thresh_05_var, \"q10\",\n                                                                                      ifelse(Yield_mm <= thresh_05_var & Yield_mm > thresh_02_var, \"q05\",  \n                                                                                             ifelse(Yield_mm <= thresh_02_var, \"q02\", \"none\")))))))))))) %>%\n  mutate(drought_fix = factor(ifelse(is.na(Yield_mm), NA, drought_fix), levels = mydroughtlevels),\n         drought_var = factor(ifelse(is.na(Yield_mm), NA, drought_var), levels = mydroughtlevels)) \ndat_clean_big_join_sub <- dat_clean_big_join %>% left_join(yrdf) %>% filter(ecodyr == \"yes\")\n\n# join data\ndat_clean_join <- bind_rows(dat_clean_little_join, dat_clean_big_join_sub)\n```\n:::\n\n\n\n\n\n\n\n### Site specific\n\nDrought/low flow delineation is somewhat complicated by the fact that some streams simply have greater yield than others. For example, at groundwater-dominated sites, the above approach will never detect low flow conditions based on big G thresholds, but this doesn't mean that flow at that site isn't lower than normal (for that site). This is most obvious in the Snake River basin, where NF Spread Creek Upper never experiences drought (because this is presumably a gaining reach) and Rock and Grouse Creeks are in a perpetual state of drought (presumable these are losing reaches). This is a classic \"At which level of organization do I standardize my data?\" question: are general differences in flow volume among sites signal or noise? But perhaps more importantly, this is a question of \"what is drought?\" Is drought relative to some larger regional metric (e.g., big G)? Or is it a local phenomenon, where the specifics of individual streams and reaches matter. \n\nFor each site individually, generate (fixed) drought/low flow thresholds using the same quantiles same as above: ~0.05 increments from 0.02 to 0.50. Restrict data to selected basins, sites, and years with (nearly) complete summer (July, August, September) data over the selected periods/locations. (Standardization needs to be done over comparable time periods, at least among sites within basins). \n\nRequire 95% data availability across all water years for site to be included!\n\nOrganize data, get site-level low flow threshold values, and denote drought periods\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Require 95% data availability!\nmonthss <- c(7:9)\n\n# grab data and bind, z-score Yield\ndat_clean_sub <- bind_rows(\n  dat_clean %>% filter(basin == \"West Brook\", WaterYear %in% c(2020:2023), Month %in% monthss, !site_name %in% c(\"Mitchell Brook\", \"West Brook Lower\")) %>%\n    bind_rows(dat_clean_big %>% filter(basin == \"West Brook\", WaterYear %in% c(2020:2023), Month %in% monthss)),\n  \n  dat_clean %>% filter(basin == \"Staunton River\", WaterYear %in% c(2019:2022), Month %in% monthss) %>%\n    bind_rows(dat_clean_big %>% filter(basin == \"Staunton River\", WaterYear %in% c(2019:2022), Month %in% monthss)),\n  \n  dat_clean %>% filter(basin == \"Flathead\", WaterYear %in% c(2019:2021), Month %in% monthss, !site_name %in% c(\"BigCreekLower\", \"LangfordCreekUpper\", \"WernerCreek\", \"CycloneCreekMiddle\", \"CoalCreekMiddle\", \"McGeeCreekUpper\")) %>%\n    bind_rows(dat_clean_big %>% filter(basin == \"Flathead\", WaterYear %in% c(2019:2021), Month %in% monthss)),\n  \n  # dat_clean %>% filter(subbasin == \"Big Creek\", WaterYear %in% c(2019:2021), Month %in% monthss, !site_name %in% c(\"BigCreekLower\", \"LangfordCreekUpper\", \"NicolaCreek\", \"WernerCreek\")) %>%\n  #   bind_rows(dat_clean_big %>% filter(basin == \"Flathead\", WaterYear %in% c(2019:2021), Month %in% monthss) %>% mutate(subbasin = \"Big Creek\")),\n  # \n  # dat_clean %>% filter(subbasin == \"Coal Creek\", WaterYear %in% c(2019:2021), Month %in% monthss, !site_name %in% c(\"CycloneCreekMiddle\", \"CoalCreekMiddle\", \"CoalCreekHeadwaters\")) %>%\n  #   bind_rows(dat_clean_big %>% filter(basin == \"Flathead\", WaterYear %in% c(2019:2021), Month %in% monthss) %>% mutate(subbasin = \"Coal Creek\")),\n  \n  dat_clean %>% filter(basin == \"Snake River\", WaterYear %in% c(2020:2022), Month %in% monthss, !site_name %in% c(\"Spread Creek Dam\")) %>%\n    bind_rows(dat_clean_big %>% filter(basin == \"Snake River\", WaterYear %in% c(2020:2022), Month %in% monthss)),\n  \n  dat_clean %>% filter(basin == \"Shields River\", WaterYear %in% c(2017, 2019, 2020, 2022), Month %in% monthss, !site_name %in% c(\"Shields River Valley Ranch\", \"Buck Creek\", \"Lodgepole Creek\")) %>% group_by(site_name) %>%\n    bind_rows(dat_clean_big %>% filter(basin == \"Shields River\", WaterYear %in% c(2017, 2019, 2020, 2022), Month %in% monthss)),\n  \n  # dat_clean %>% filter(subbasin == \"Shields River\", WaterYear %in% c(2019, 2020, 2023), Month %in% monthss, !site_name %in% c(\"Shields River Valley Ranch\")) %>% group_by(site_name) %>%\n  #   bind_rows(dat_clean_big %>% filter(basin == \"Shields River\", WaterYear %in% c(2019, 2020, 2023), Month %in% monthss)),\n  # \n  # dat_clean %>% filter(subbasin == \"Duck Creek\", WaterYear %in% c(2017:2022), Month %in% monthss) %>%\n  #   bind_rows(dat_clean_big %>% filter(basin == \"Shields River\", WaterYear %in% c(2017:2022), Month %in% monthss) %>% mutate(subbasin = \"Duck Creek\")),\n  \n  dat_clean %>% filter(basin == \"Donner Blitzen\", WaterYear %in% c(2019:2022), Month %in% monthss) %>%\n    bind_rows(dat_clean_big %>% filter(basin == \"Donner Blitzen\", WaterYear %in% c(2019:2022), Month %in% monthss))\n) %>%\n  group_by(site_name) %>%\n  mutate(z_Yield_mm = scale(Yield_mm, center = TRUE, scale = TRUE)[,1]) %>%\n  ungroup()\n\n# get low flow thresholds\ndat_clean_sub_thresh <- dat_clean_sub %>% \n  group_by(site_name) %>%\n  summarize(thresh_50_fix = quantile(z_Yield_mm, probs = 0.50, na.rm = TRUE),\n            thresh_45_fix = quantile(z_Yield_mm, probs = 0.45, na.rm = TRUE),\n            thresh_40_fix = quantile(z_Yield_mm, probs = 0.40, na.rm = TRUE),\n            thresh_35_fix = quantile(z_Yield_mm, probs = 0.35, na.rm = TRUE),\n            thresh_30_fix = quantile(z_Yield_mm, probs = 0.30, na.rm = TRUE),\n            thresh_25_fix = quantile(z_Yield_mm, probs = 0.25, na.rm = TRUE),\n            thresh_20_fix = quantile(z_Yield_mm, probs = 0.20, na.rm = TRUE),\n            thresh_15_fix = quantile(z_Yield_mm, probs = 0.15, na.rm = TRUE),\n            thresh_10_fix = quantile(z_Yield_mm, probs = 0.10, na.rm = TRUE),\n            thresh_05_fix = quantile(z_Yield_mm, probs = 0.05, na.rm = TRUE),\n            thresh_02_fix = quantile(z_Yield_mm, probs = 0.02, na.rm = TRUE)) %>%\n  ungroup()\ndat_clean_sub_thresh\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 52 × 12\n   site_name           thresh_50_fix thresh_45_fix thresh_40_fix thresh_35_fix\n   <chr>                       <dbl>         <dbl>         <dbl>         <dbl>\n 1 Avery Brook                -0.263        -0.308        -0.336        -0.348\n 2 Big Creek NWIS             -0.380        -0.421        -0.474        -0.532\n 3 BigCreekUpper              -0.435        -0.488        -0.532        -0.576\n 4 CoalCreekHeadwaters        -0.345        -0.359        -0.368        -0.379\n 5 CoalCreekLower             -0.378        -0.443        -0.507        -0.553\n 6 CoalCreekNorth             -0.349        -0.429        -0.488        -0.548\n 7 Crandall Creek             -0.347        -0.465        -0.526        -0.588\n 8 CycloneCreekLower          -0.225        -0.313        -0.405        -0.457\n 9 CycloneCreekUpper          -0.504        -0.555        -0.596        -0.617\n10 Deep Creek                 -0.340        -0.396        -0.441        -0.488\n# ℹ 42 more rows\n# ℹ 7 more variables: thresh_30_fix <dbl>, thresh_25_fix <dbl>,\n#   thresh_20_fix <dbl>, thresh_15_fix <dbl>, thresh_10_fix <dbl>,\n#   thresh_05_fix <dbl>, thresh_02_fix <dbl>\n```\n\n\n:::\n\n```{.r .cell-code}\n# join thresholds to data and denote drought periods\ndat_clean_sub <- dat_clean_sub %>% \n  left_join(dat_clean_sub_thresh) %>%\n  mutate(month = month(date),\n         year = year(date),\n         drought_fix = ifelse(z_Yield_mm <= thresh_50_fix & z_Yield_mm > thresh_45_fix, \"q50\",\n                              ifelse(z_Yield_mm <= thresh_45_fix & z_Yield_mm > thresh_40_fix, \"q45\",\n                                     ifelse(z_Yield_mm <= thresh_40_fix & z_Yield_mm > thresh_35_fix, \"q40\",\n                                            ifelse(z_Yield_mm <= thresh_35_fix & z_Yield_mm > thresh_30_fix, \"q35\",\n                                                   ifelse(z_Yield_mm <= thresh_30_fix & z_Yield_mm > thresh_25_fix, \"q30\",\n                                                          ifelse(z_Yield_mm <= thresh_25_fix & z_Yield_mm > thresh_20_fix, \"q25\",\n                                                                 ifelse(z_Yield_mm <= thresh_20_fix & z_Yield_mm > thresh_15_fix, \"q20\",\n                                                                        ifelse(z_Yield_mm <= thresh_15_fix & z_Yield_mm > thresh_10_fix, \"q15\",\n                                                                               ifelse(z_Yield_mm <= thresh_10_fix & z_Yield_mm > thresh_05_fix, \"q10\",\n                                                                                      ifelse(z_Yield_mm <= thresh_05_fix & z_Yield_mm > thresh_02_fix, \"q05\",  \n                                                                                             ifelse(z_Yield_mm <= thresh_02_fix, \"q02\", \"none\")))))))))))) %>%\n  mutate(drought_fix = factor(ifelse(is.na(Yield_mm), NA, drought_fix), levels = mydroughtlevels)) \ndat_clean_sub\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 16,731 × 31\n   site_name   basin    subbasin region date       flow_mean tempc_mean Yield_mm\n   <chr>       <chr>    <chr>    <chr>  <date>         <dbl>      <dbl>    <dbl>\n 1 Avery Brook West Br… West Br… Mass   2020-07-01     1.34        16.0    0.446\n 2 Avery Brook West Br… West Br… Mass   2020-07-02     0.963       16.1    0.321\n 3 Avery Brook West Br… West Br… Mass   2020-07-03     2.40        17.3    0.800\n 4 Avery Brook West Br… West Br… Mass   2020-07-04     3.31        17.4    1.10 \n 5 Avery Brook West Br… West Br… Mass   2020-07-05     1.38        17.5    0.460\n 6 Avery Brook West Br… West Br… Mass   2020-07-06     0.965       17.5    0.322\n 7 Avery Brook West Br… West Br… Mass   2020-07-07     0.778       17.3    0.259\n 8 Avery Brook West Br… West Br… Mass   2020-07-08     0.795       17.3    0.265\n 9 Avery Brook West Br… West Br… Mass   2020-07-09     1.07        17.9    0.356\n10 Avery Brook West Br… West Br… Mass   2020-07-10    14.3         19.4    4.76 \n# ℹ 16,721 more rows\n# ℹ 23 more variables: CalendarYear <dbl>, Month <dbl>, MonthName <chr>,\n#   WaterYear <dbl>, DayofYear <dbl>, logYield <dbl>, designation <chr>,\n#   doy_calendar <dbl>, z_Yield_mm <dbl>, thresh_50_fix <dbl>,\n#   thresh_45_fix <dbl>, thresh_40_fix <dbl>, thresh_35_fix <dbl>,\n#   thresh_30_fix <dbl>, thresh_25_fix <dbl>, thresh_20_fix <dbl>,\n#   thresh_15_fix <dbl>, thresh_10_fix <dbl>, thresh_05_fix <dbl>, …\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n## Low flow heatmaps\n\nCreate heatmap functions\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# fixed drought threshold\nheatmapfun_fix <- function(bas, months, bigG, orderr) {\n  dd <- dat_clean_join %>% filter(basin == bas | site_name == bigG, month %in% months)\n  mysites <- c(unique(unlist(dd %>% filter(designation == \"big\") %>% select(site_name))),\n               orderr\n               #unique(unlist(dd %>% filter(designation == \"little\") %>% select(site_name)))\n               )\n  myrect <- dd %>% group_by(WaterYear) %>% summarize(mindate = min(date), maxdate = max(date)) %>% ungroup()\n  p <- dd %>%\n    ggplot() +\n    geom_tile(aes(x = date, y = factor(site_name, levels = rev(mysites)), fill = drought_fix)) +\n    scale_fill_viridis(option = \"A\", direction = -1, discrete = TRUE, limits = mydroughtlevels) +\n    geom_rect(data = myrect, aes(xmin = mindate, xmax = maxdate, ymin = length(mysites)-0.5, ymax = length(mysites)+0.5), \n              color = \"grey70\", fill = NA, size = 1.25) +\n    xlab(\"Date\") + ylab(\"Site\") +\n    #facet_wrap(~WaterYear, scales = \"free_x\") + \n    facet_wrap2(~WaterYear, scales = \"free_x\", nrow = 3, ncol = 3, trim_blank = FALSE) +\n    theme_bw() + theme(axis.title = element_blank())\nreturn(p)\n}\n# variable drought threshold\nheatmapfun_var <- function(bas, months, bigG, orderr) {\n  dd <- dat_clean_join %>% filter(basin == bas | site_name == bigG, month %in% months)\n  mysites <- c(unique(unlist(dd %>% filter(designation == \"big\") %>% select(site_name))),\n               orderr\n               #unique(unlist(dd %>% filter(designation == \"little\") %>% select(site_name)))\n               )\n  myrect <- dd %>% group_by(WaterYear) %>% summarize(mindate = min(date), maxdate = max(date)) %>% ungroup()\n  p <- dd %>%\n    ggplot() +\n    geom_tile(aes(x = date, y = factor(site_name, levels = rev(mysites)), fill = drought_var)) +\n    scale_fill_viridis(option = \"A\", direction = -1, discrete = TRUE, limits = mydroughtlevels) +\n    geom_rect(data = myrect, aes(xmin = mindate, xmax = maxdate, ymin = length(mysites)-0.5, ymax = length(mysites)+0.5), \n              color = \"grey70\", fill = NA, size = 1.25) +\n    xlab(\"Date\") + ylab(\"Site\") +\n    #facet_wrap(~WaterYear, scales = \"free_x\") +\n    facet_wrap2(~WaterYear, scales = \"free_x\", nrow = 3, ncol = 3, trim_blank = FALSE) +\n    theme_bw() + theme(axis.title = element_blank())\nreturn(p)\n}\n# site-level drought threshold\nheatmapfun_site <- function(bas, months, bigG, orderr) {\n  dd <- dat_clean_sub %>% filter(basin == bas)\n  mysites <- c(unique(unlist(dd %>% filter(site_name != bigG) %>% select(site_name))), bigG)\n  myrect <- dd %>% group_by(WaterYear) %>% summarize(mindate = min(date), maxdate = max(date)) %>% ungroup()\n  p <- dd %>%\n    ggplot() +\n    geom_tile(aes(x = date, y = factor(site_name, levels = c(rev(orderr), bigG)), fill = drought_fix)) +\n    scale_fill_viridis(option = \"A\", direction = -1, discrete = TRUE, limits = mydroughtlevels) +\n    geom_rect(data = myrect, aes(xmin = mindate, xmax = maxdate, ymin = length(mysites)-0.5, ymax = length(mysites)+0.5), \n              color = \"grey70\", fill = NA, size = 1.25) +\n    xlab(\"Date\") + ylab(\"Site\") +\n    #facet_wrap(~WaterYear, scales = \"free_x\") + \n    facet_wrap2(~WaterYear, scales = \"free_x\", nrow = 2, ncol = 3, trim_blank = FALSE) +\n    theme_bw() + theme(axis.title = element_blank())\nreturn(p)\n}\n```\n:::\n\n\n\n\n\n\n### Fixed threshold\n::: panel-tabset\n#### West Brook\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_fix(bas = \"West Brook\", bigG = \"South River Conway NWIS\", months = c(7:9), orderr = wborder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-13-1.png){width=864}\n:::\n:::\n\n\n\n\n\n#### Paine Run\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_fix(bas = \"Paine Run\", bigG = \"South River Harriston NWIS\", months = c(7:9), orderr = paineorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-14-1.png){width=864}\n:::\n:::\n\n\n\n\n\n#### Staunton River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_fix(bas = \"Staunton River\", bigG = \"Rapidan River NWIS\", months = c(7:9), orderr = stauntorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-15-1.png){width=864}\n:::\n:::\n\n\n\n\n\n#### Flathead\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_fix(bas = \"Flathead\", bigG = \"North Fork Flathead River NWIS\", months = c(7:9), orderr = flatorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-16-1.png){width=864}\n:::\n:::\n\n\n\n\n\n#### Snake River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_fix(bas = \"Snake River\", bigG = \"Pacific Creek at Moran NWIS\", months = c(7:9), orderr = snakeorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-17-1.png){width=864}\n:::\n:::\n\n\n\n\n\n#### Yellowstone River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_fix(bas = \"Shields River\", bigG = \"Yellowstone River Livingston NWIS\", months = c(7:9), orderr = yellorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-18-1.png){width=864}\n:::\n:::\n\n\n\n\n\n\n#### Donner Blitzen\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_fix(bas = \"Donner Blitzen\", bigG = \"Donner Blitzen River nr Frenchglen NWIS\", months = c(7:9), orderr = donnerorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-19-1.png){width=864}\n:::\n:::\n\n\n\n\n\n:::\n\n### Variable threshold\n::: panel-tabset\n#### West Brook\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_var(bas = \"West Brook\", bigG = \"South River Conway NWIS\", months = c(7:9), orderr = wborder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-20-1.png){width=864}\n:::\n:::\n\n\n\n\n\n#### Paine Run\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_var(bas = \"Paine Run\", bigG = \"South River Harriston NWIS\", months = c(7:9), orderr = paineorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-21-1.png){width=864}\n:::\n:::\n\n\n\n\n\n#### Staunton River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_var(bas = \"Staunton River\", bigG = \"Rapidan River NWIS\", months = c(7:9), orderr = stauntorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-22-1.png){width=864}\n:::\n:::\n\n\n\n\n\n#### Flathead\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_var(bas = \"Flathead\", bigG = \"North Fork Flathead River NWIS\", months = c(7:9), orderr = flatorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-23-1.png){width=864}\n:::\n:::\n\n\n\n\n\n#### Snake River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_var(bas = \"Snake River\", bigG = \"Pacific Creek at Moran NWIS\", months = c(7:9), orderr = snakeorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-24-1.png){width=864}\n:::\n:::\n\n\n\n\n\n#### Yellowstone River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_var(bas = \"Shields River\", bigG = \"Yellowstone River Livingston NWIS\", months = c(7:9), orderr = yellorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-25-1.png){width=864}\n:::\n:::\n\n\n\n\n\n#### Donner Blitzen\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_var(bas = \"Donner Blitzen\", bigG = \"Donner Blitzen River nr Frenchglen NWIS\", months = c(7:9), orderr = donnerorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-26-1.png){width=864}\n:::\n:::\n\n\n\n\n\n:::\n\n\n### Site-specific threshold\n::: panel-tabset\n#### West Brook\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_site(bas = \"West Brook\", bigG = \"South River Conway NWIS\", months = c(7:9), orderr = wborder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-27-1.png){width=864}\n:::\n:::\n\n\n\n\n\n#### Staunton River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_site(bas = \"Staunton River\", bigG = \"Rapidan River NWIS\", months = c(7:9), orderr = stauntorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-28-1.png){width=864}\n:::\n:::\n\n\n\n\n\n#### Flathead\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_site(bas = \"Flathead\", bigG = \"North Fork Flathead River NWIS\", months = c(7:9), orderr = flatorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-29-1.png){width=864}\n:::\n:::\n\n\n\n\n\n#### Snake River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_site(bas = \"Snake River\", bigG = \"Pacific Creek at Moran NWIS\", months = c(7:9), order = snakeorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-30-1.png){width=864}\n:::\n:::\n\n\n\n\n\n#### Yellowstone River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_site(bas = \"Shields River\", bigG = \"Yellowstone River Livingston NWIS\", months = c(7:9), orderr = yellorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-31-1.png){width=864}\n:::\n:::\n\n\n\n\n\n#### Donner Blitzen\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheatmapfun_site(bas = \"Donner Blitzen\", bigG = \"Donner Blitzen River nr Frenchglen NWIS\", months = c(7:9), orderr = donnerorder)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-32-1.png){width=864}\n:::\n:::\n\n\n\n\n\n:::\n\n\n## Deficit and duration\n\n### Fixed threshold\n\nCalculate daily deficit, then summarize deficit magnitude and duration by site and month.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# calculate daily deficit\ndat_clean_join_deficit <- dat_clean_join %>%\n  mutate(deficit_50_fix = ifelse(Yield_mm < thresh_50_fix, thresh_50_fix - Yield_mm, 0),\n         deficit_45_fix = ifelse(Yield_mm < thresh_45_fix, thresh_45_fix - Yield_mm, 0),\n         deficit_40_fix = ifelse(Yield_mm < thresh_40_fix, thresh_40_fix - Yield_mm, 0),\n         deficit_35_fix = ifelse(Yield_mm < thresh_35_fix, thresh_35_fix - Yield_mm, 0),\n         deficit_30_fix = ifelse(Yield_mm < thresh_30_fix, thresh_30_fix - Yield_mm, 0),\n         deficit_25_fix = ifelse(Yield_mm < thresh_25_fix, thresh_25_fix - Yield_mm, 0),\n         deficit_20_fix = ifelse(Yield_mm < thresh_20_fix, thresh_20_fix - Yield_mm, 0),\n         deficit_15_fix = ifelse(Yield_mm < thresh_15_fix, thresh_15_fix - Yield_mm, 0),\n         deficit_10_fix = ifelse(Yield_mm < thresh_10_fix, thresh_10_fix - Yield_mm, 0),\n         deficit_05_fix = ifelse(Yield_mm < thresh_05_fix, thresh_05_fix - Yield_mm, 0),\n         deficit_02_fix = ifelse(Yield_mm < thresh_02_fix, thresh_02_fix - Yield_mm, 0),\n         \n         deficit_50_var = ifelse(Yield_mm < thresh_50_var, thresh_50_var - Yield_mm, 0),\n         deficit_45_var = ifelse(Yield_mm < thresh_45_var, thresh_45_var - Yield_mm, 0),\n         deficit_40_var = ifelse(Yield_mm < thresh_40_var, thresh_40_var - Yield_mm, 0),\n         deficit_35_var = ifelse(Yield_mm < thresh_35_var, thresh_35_var - Yield_mm, 0),\n         deficit_30_var = ifelse(Yield_mm < thresh_30_var, thresh_30_var - Yield_mm, 0),\n         deficit_25_var = ifelse(Yield_mm < thresh_25_var, thresh_25_var - Yield_mm, 0),\n         deficit_20_var = ifelse(Yield_mm < thresh_20_var, thresh_20_var - Yield_mm, 0),\n         deficit_15_var = ifelse(Yield_mm < thresh_15_var, thresh_15_var - Yield_mm, 0),\n         deficit_10_var = ifelse(Yield_mm < thresh_10_var, thresh_10_var - Yield_mm, 0),\n         deficit_05_var = ifelse(Yield_mm < thresh_05_var, thresh_05_var - Yield_mm, 0),\n         deficit_02_var = ifelse(Yield_mm < thresh_02_var, thresh_02_var - Yield_mm, 0))\n\n# # fill missing dates\n# dat_clean_join_deficit <- fill_missing_dates(dat_clean_join_deficit, dates = date, groups = site_name, pad_ends = TRUE)\n# \n# # fill ragged basin, subbasin, region, date variables\n# dat_clean_join_deficit <- dat_clean_join_deficit %>% \n#   select(-c(basin, subbasin, region, CalendarYear, Month, MonthName, WaterYear, DayofYear, designation)) %>% \n#   left_join(siteinfo %>% \n#               mutate(designation = ifelse(site_name %in% unique(dat_clean_big$site_name), \"big\", \"little\")) %>% \n#               select(site_name, basin, subbasin, region, designation))\n# dat_clean_join_deficit <- add_date_variables(dat_clean_join_deficit, dates = date, water_year_start = 10)\n# \n# # summarize by month\n# defdur_month <- dat_clean_join_deficit %>% \n#   group_by(site_name, basin, subbasin, region, designation, CalendarYear, Month, MonthName, WaterYear) %>% \n#   summarize(ndays = n(), \n#             duration_50_fix = sum(deficit_50_fix > 0),\n#             duration_45_fix = sum(deficit_45_fix > 0),\n#             duration_40_fix = sum(deficit_40_fix > 0),\n#             duration_35_fix = sum(deficit_35_fix > 0),\n#             duration_30_fix = sum(deficit_30_fix > 0),\n#             duration_25_fix = sum(deficit_25_fix > 0),\n#             duration_20_fix = sum(deficit_20_fix > 0),\n#             duration_15_fix = sum(deficit_15_fix > 0),\n#             duration_10_fix = sum(deficit_10_fix > 0),\n#             duration_05_fix = sum(deficit_05_fix > 0),\n#             duration_02_fix = sum(deficit_02_fix > 0),\n#             \n#             duration_50_var = sum(deficit_50_var > 0),\n#             duration_45_var = sum(deficit_45_var > 0),\n#             duration_40_var = sum(deficit_40_var > 0),\n#             duration_35_var = sum(deficit_35_var > 0),\n#             duration_30_var = sum(deficit_30_var > 0),\n#             duration_25_var = sum(deficit_25_var > 0),\n#             duration_20_var = sum(deficit_20_var > 0),\n#             duration_15_var = sum(deficit_15_var > 0),\n#             duration_10_var = sum(deficit_10_var > 0),\n#             duration_05_var = sum(deficit_05_var > 0),\n#             duration_02_var = sum(deficit_02_var > 0),\n#             \n#             deficit_50_fix = sum(deficit_50_fix),\n#             deficit_45_fix = sum(deficit_45_fix),\n#             deficit_40_fix = sum(deficit_40_fix),\n#             deficit_35_fix = sum(deficit_35_fix),\n#             deficit_30_fix = sum(deficit_30_fix),\n#             deficit_25_fix = sum(deficit_25_fix),\n#             deficit_20_fix = sum(deficit_20_fix),\n#             deficit_15_fix = sum(deficit_15_fix),\n#             deficit_10_fix = sum(deficit_10_fix),\n#             deficit_05_fix = sum(deficit_05_fix),\n#             deficit_02_fix = sum(deficit_02_fix),\n#             \n#             deficit_50_var = sum(deficit_50_var),\n#             deficit_45_var = sum(deficit_45_var),\n#             deficit_40_var = sum(deficit_40_var),\n#             deficit_35_var = sum(deficit_35_var),\n#             deficit_30_var = sum(deficit_30_var),\n#             deficit_25_var = sum(deficit_25_var),\n#             deficit_20_var = sum(deficit_20_var),\n#             deficit_15_var = sum(deficit_15_var),\n#             deficit_10_var = sum(deficit_10_var),\n#             deficit_05_var = sum(deficit_05_var),\n#             deficit_02_var = sum(deficit_02_var)) %>%\n#   ungroup() %>%\n#   left_join(wateravail %>% select(basin, WaterYear, totalyield, totalyield_z))\n\n# summarize by summer\ndefdur_ssn <- dat_clean_join_deficit %>% \n  filter(!is.na(Yield_mm), Month %in% c(7:9)) %>% \n  group_by(site_name, basin, subbasin, region, designation, CalendarYear, WaterYear) %>% \n  summarize(ndays = n(),\n            propdays = ndays/(31+31+30), \n            \n            duration_50_fix = sum(deficit_50_fix > 0),\n            duration_45_fix = sum(deficit_45_fix > 0),\n            duration_40_fix = sum(deficit_40_fix > 0),\n            duration_35_fix = sum(deficit_35_fix > 0),\n            duration_30_fix = sum(deficit_30_fix > 0),\n            duration_25_fix = sum(deficit_25_fix > 0),\n            duration_20_fix = sum(deficit_20_fix > 0),\n            duration_15_fix = sum(deficit_15_fix > 0),\n            duration_10_fix = sum(deficit_10_fix > 0),\n            duration_05_fix = sum(deficit_05_fix > 0),\n            duration_02_fix = sum(deficit_02_fix > 0),\n            \n            duration_50_var = sum(deficit_50_var > 0),\n            duration_45_var = sum(deficit_45_var > 0),\n            duration_40_var = sum(deficit_40_var > 0),\n            duration_35_var = sum(deficit_35_var > 0),\n            duration_30_var = sum(deficit_30_var > 0),\n            duration_25_var = sum(deficit_25_var > 0),\n            duration_20_var = sum(deficit_20_var > 0),\n            duration_15_var = sum(deficit_15_var > 0),\n            duration_10_var = sum(deficit_10_var > 0),\n            duration_05_var = sum(deficit_05_var > 0),\n            duration_02_var = sum(deficit_02_var > 0),\n            \n            duration_50_fix_prop = sum(deficit_50_fix > 0) / ndays,\n            duration_45_fix_prop = sum(deficit_45_fix > 0) / ndays,\n            duration_40_fix_prop = sum(deficit_40_fix > 0) / ndays,\n            duration_35_fix_prop = sum(deficit_35_fix > 0) / ndays,\n            duration_30_fix_prop = sum(deficit_30_fix > 0) / ndays,\n            duration_25_fix_prop = sum(deficit_25_fix > 0) / ndays,\n            duration_20_fix_prop = sum(deficit_20_fix > 0) / ndays,\n            duration_15_fix_prop = sum(deficit_15_fix > 0) / ndays,\n            duration_10_fix_prop = sum(deficit_10_fix > 0) / ndays,\n            duration_05_fix_prop = sum(deficit_05_fix > 0) / ndays,\n            duration_02_fix_prop = sum(deficit_02_fix > 0) / ndays,\n            \n            duration_50_var_prop = sum(deficit_50_var > 0) / ndays,\n            duration_45_var_prop = sum(deficit_45_var > 0) / ndays,\n            duration_40_var_prop = sum(deficit_40_var > 0) / ndays,\n            duration_35_var_prop = sum(deficit_35_var > 0) / ndays,\n            duration_30_var_prop = sum(deficit_30_var > 0) / ndays,\n            duration_25_var_prop = sum(deficit_25_var > 0) / ndays,\n            duration_20_var_prop = sum(deficit_20_var > 0) / ndays,\n            duration_15_var_prop = sum(deficit_15_var > 0) / ndays,\n            duration_10_var_prop = sum(deficit_10_var > 0) / ndays,\n            duration_05_var_prop = sum(deficit_05_var > 0) / ndays,\n            duration_02_var_prop = sum(deficit_02_var > 0) / ndays,\n            \n            deficit_50_fix = sum(deficit_50_fix),\n            deficit_45_fix = sum(deficit_45_fix),\n            deficit_40_fix = sum(deficit_40_fix),\n            deficit_35_fix = sum(deficit_35_fix),\n            deficit_30_fix = sum(deficit_30_fix),\n            deficit_25_fix = sum(deficit_25_fix),\n            deficit_20_fix = sum(deficit_20_fix),\n            deficit_15_fix = sum(deficit_15_fix),\n            deficit_10_fix = sum(deficit_10_fix),\n            deficit_05_fix = sum(deficit_05_fix),\n            deficit_02_fix = sum(deficit_02_fix),\n            \n            deficit_50_var = sum(deficit_50_var),\n            deficit_45_var = sum(deficit_45_var),\n            deficit_40_var = sum(deficit_40_var),\n            deficit_35_var = sum(deficit_35_var),\n            deficit_30_var = sum(deficit_30_var),\n            deficit_25_var = sum(deficit_25_var),\n            deficit_20_var = sum(deficit_20_var),\n            deficit_15_var = sum(deficit_15_var),\n            deficit_10_var = sum(deficit_10_var),\n            deficit_05_var = sum(deficit_05_var),\n            deficit_02_var = sum(deficit_02_var)) %>%\n  ungroup() %>%\n  filter(propdays >= 0.70) %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield, totalyield_z))\n```\n:::\n\n\n\n\n\n\nCreate plotting functions\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndurationplotfun <- function(bas, bigG, months, wateryears, dropsites = NA) {\n  # filter and summarize data\n  # dd <- defdur_month %>% \n  #   filter(subbasin == subbas | site_name == bigG, Month %in% months, WaterYear %in% wateryears, !site_name %in% dropsites) %>%\n  #   mutate(WaterYear = factor(WaterYear, levels = wateryears)) %>% \n  #   group_by(site_name, designation, WaterYear, totalyield_z) %>%\n  #   summarize(duration_50_fix_prop = sum(duration_50_fix) / sum(ndays),\n  #             duration_45_fix_prop = sum(duration_45_fix) / sum(ndays),\n  #             duration_40_fix_prop = sum(duration_40_fix) / sum(ndays),\n  #             duration_35_fix_prop = sum(duration_35_fix) / sum(ndays),\n  #             duration_30_fix_prop = sum(duration_30_fix) / sum(ndays),\n  #             duration_25_fix_prop = sum(duration_25_fix) / sum(ndays),\n  #             duration_20_fix_prop = sum(duration_20_fix) / sum(ndays),\n  #             duration_15_fix_prop = sum(duration_15_fix) / sum(ndays),\n  #             duration_10_fix_prop = sum(duration_10_fix) / sum(ndays),\n  #             duration_05_fix_prop = sum(duration_05_fix) / sum(ndays),\n  #             duration_02_fix_prop = sum(duration_02_fix) / sum(ndays)) %>%\n  #   ungroup()\n  dd <- defdur_ssn %>% \n    filter(basin == bas | site_name == bigG, WaterYear %in% wateryears, !site_name %in% dropsites) %>%\n    mutate(WaterYear = factor(WaterYear, levels = wateryears))\n\n  # order sites, Big G first\n  mysites <- c(unique(unlist(dd %>% filter(designation == \"big\") %>% select(site_name))),\n               unique(unlist(dd %>% filter(designation == \"little\") %>% select(site_name))))\n\n  # among site StDev ~ percentile\n  p_sds <- dd %>% \n    gather(duration_50_fix_prop:duration_02_fix_prop, key = \"metric\", value = \"duration\") %>%\n    mutate(quant = as.numeric(gsub(\".*?([0-9]+).*\", \"\\\\1\", metric)) ) %>% \n    filter(designation == \"little\") %>%\n    group_by(WaterYear, totalyield_z, metric, quant) %>%\n    summarize(sddur = sd(duration, na.rm = TRUE)) %>%\n    ungroup() %>%\n    #left_join(dd %>% filter(site_name == bigG) %>% select(WaterYear, duration_50_fix_prop) %>% rename(dur50 = duration_50_fix_prop)) %>%\n    left_join(wateravail %>% filter(site_name == bigG) %>% select(WaterYear, tyz_sum_perc) %>% mutate(WaterYear = as.factor(WaterYear))) %>%\n    ggplot(aes(x = quant, y = sddur, color = tyz_sum_perc, group = WaterYear, shape = WaterYear)) +\n    geom_point() +\n    scale_color_gradient(low = \"red\", high = \"blue\", limits = c(0,100)) +\n    stat_smooth() +\n    xlab(\"Low flow threshold (percentile)\") + ylab(\"Among-site SD(duration)\") +\n    theme_bw() + \n    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),\n          legend.position = \"bottom\", legend.direction = \"vertical\", legend.key.height = unit(0.3, 'cm')) \n  \n  # barplot 50th perc\n  p30 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = duration_50_fix_prop)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,1) +\n    ylab(\"Days below low flow threshold (%JAS)\") + ggtitle(\"50th perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n  # barplot 25th perc.\n  p20 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = duration_25_fix_prop)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,1) +\n    ylab(\"Days below low flow threshold (%JAS)\") + ggtitle(\"25th perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n  # barplot 10th perc.\n  p10 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = duration_10_fix_prop)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,1) +\n    ylab(\"Days below low flow threshold (%JAS)\") + ggtitle(\"10th perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n  # barplot 5th perc.\n  p05 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = duration_05_fix_prop)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,1) +\n    ylab(\"Days below low flow threshold (%JAS)\") + ggtitle(\"5th perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n  # barplot 2nd perc\n  p02 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = duration_02_fix_prop)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,1) +\n    ylab(\"Days below low flow threshold (%JAS)\") + ggtitle(\"2nd perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n\n  # arrange plots\n  egg::ggarrange(p02 + theme(plot.margin = margin(r = 1, t = 5, b = 5)), \n                 p05 + theme(axis.text.y = element_blank(), axis.title.y = element_blank(), plot.margin = margin(r = 1, l = 1)), \n                 p10 + theme(axis.text.y = element_blank(), axis.title.y = element_blank(), plot.margin = margin(r = 1, l = 1)), \n                 p20 + theme(axis.text.y = element_blank(), axis.title.y = element_blank(), plot.margin = margin(r = 1, l = 1)), \n                 p30 + theme(axis.text.y = element_blank(), axis.title.y = element_blank(), plot.margin = margin(r = 1, l = 1)),\n                 p_sds,\n                 nrow = 1, widths = c(1,1,1,1,1,2.5))\n}\n\n\ndeficitplotfun <- function(bas, bigG, months, wateryears, dropsites = NA) {\n  # filter and summarize data\n  # dd <- defdur_month %>% \n  #   filter(subbasin == subbas | site_name == bigG, Month %in% months, WaterYear %in% wateryears, !site_name %in% dropsites) %>%\n  #   mutate(WaterYear = factor(WaterYear, levels = wateryears)) %>% \n  #   group_by(site_name, designation, WaterYear, totalyield_z) %>%\n  #   summarize(deficit_50_fix = sum(deficit_50_fix),\n  #             deficit_45_fix = sum(deficit_45_fix),\n  #             deficit_40_fix = sum(deficit_40_fix),\n  #             deficit_35_fix = sum(deficit_35_fix),\n  #             deficit_30_fix = sum(deficit_30_fix),\n  #             deficit_25_fix = sum(deficit_25_fix),\n  #             deficit_20_fix = sum(deficit_20_fix),\n  #             deficit_15_fix = sum(deficit_15_fix),\n  #             deficit_10_fix = sum(deficit_10_fix),\n  #             deficit_05_fix = sum(deficit_05_fix),\n  #             deficit_02_fix = sum(deficit_02_fix)) %>%\n  #   ungroup()\n  dd_all <- defdur_ssn %>% filter(basin == bas | site_name == bigG, WaterYear %in% wateryears, !site_name %in% dropsites) \n  dd <- defdur_ssn %>% \n    filter(basin == bas | site_name == bigG, WaterYear %in% wateryears, !site_name %in% dropsites) %>%\n    mutate(WaterYear = factor(WaterYear, levels = wateryears))\n  \n  # get y-axis limit\n  ymax <- max(dd %>% select(deficit_50_fix:deficit_02_fix))\n\n  # order sites, Big G first\n  mysites <- c(unique(unlist(dd %>% filter(designation == \"big\") %>% select(site_name))),\n               unique(unlist(dd %>% filter(designation == \"little\") %>% select(site_name))))\n\n  # among site StDev ~ percentile\n  p_sds <- dd %>% \n    gather(deficit_50_fix:deficit_02_fix, key = \"metric\", value = \"deficit\") %>%\n    mutate(quant = as.numeric(gsub(\".*?([0-9]+).*\", \"\\\\1\", metric)) ) %>% \n    filter(designation == \"little\") %>%\n    group_by(WaterYear, totalyield_z, metric, quant) %>%\n    summarize(sddur = sd(deficit, na.rm = TRUE)) %>%\n    ungroup() %>%\n    #left_join(dd %>% filter(site_name == bigG) %>% select(WaterYear, deficit_50_fix) %>% rename(def50 = deficit_50_fix)) %>%\n    left_join(wateravail %>% filter(site_name == bigG) %>% select(WaterYear, tyz_sum_perc) %>% mutate(WaterYear = as.factor(WaterYear))) %>%\n    ggplot(aes(x = quant, y = sddur, color = tyz_sum_perc, group = WaterYear, shape = WaterYear)) +\n    geom_point() +\n    scale_color_gradient(low = \"red\", high = \"blue\", limits = c(0,100)) +\n    stat_smooth() +\n    xlab(\"Low flow threshold (percentile)\") + ylab(\"Among-site SD(deficit)\") +\n    theme_bw() + \n    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),\n          legend.position = \"bottom\", legend.direction = \"vertical\", legend.key.height = unit(0.3, 'cm'))\n  \n  # barplot 50th perc\n  p30 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = deficit_50_fix)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,ymax) +\n    ylab(\"Drought deficit (mm, JAS)\") + ggtitle(\"50th perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n  # barplot 25th perc.\n  p20 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = deficit_25_fix)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,ymax) +\n    ylab(\"Drought deficit (mm, JAS)\") + ggtitle(\"25th perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n  # barplot 10th perc.\n  p10 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = deficit_10_fix)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,ymax) +\n    ylab(\"Drought deficit (mm, JAS)\") + ggtitle(\"10th perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n  # barplot 5th perc.\n  p05 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = deficit_05_fix)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,ymax) +\n    ylab(\"Drought deficit (mm, JAS)\") + ggtitle(\"5th perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n  # barplot 2nd perc\n  p02 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = deficit_02_fix)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,ymax) +\n    ylab(\"Drought deficit (JAS)\") + ggtitle(\"2nd perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n\n  # arrange plots\n  egg::ggarrange(p02 + theme(plot.margin = margin(r = 1, t = 5, b = 5)), \n                 p05 + theme(axis.text.y = element_blank(), axis.title.y = element_blank(), plot.margin = margin(r = 1, l = 1)), \n                 p10 + theme(axis.text.y = element_blank(), axis.title.y = element_blank(), plot.margin = margin(r = 1, l = 1)), \n                 p20 + theme(axis.text.y = element_blank(), axis.title.y = element_blank(), plot.margin = margin(r = 1, l = 1)), \n                 p30 + theme(axis.text.y = element_blank(), axis.title.y = element_blank(), plot.margin = margin(r = 1, l = 1)),\n                 p_sds,\n                 nrow = 1, widths = c(1,1,1,1,1,2.5))\n}\n```\n:::\n\n\n\n\n\n\n#### Duration\n\nShow proportion of days (July - September) below different low flow thresholds (derived from long-term Big G data) for each site during a relatively wet year and a dry year. Then, for each year, plot the relationship between the among site (little g's only) standard deviation of low flow duration and the low flow threshold used to calculate duration\n\n::: panel-tabset\n##### West Brook\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndurationplotfun(bas = \"West Brook\", bigG = \"South River Conway NWIS\", months = c(7:9), wateryears = c(2020, 2021))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-35-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Staunton River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndurationplotfun(bas = \"Staunton River\", bigG = \"Rapidan River NWIS\", months = c(7:9), wateryears = c(2019, 2020))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-36-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Flathead\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndurationplotfun(bas = \"Flathead\", bigG = \"North Fork Flathead River NWIS\", months = c(7:9), wateryears = c(2020, 2021), dropsites = c(\"BigCreekLower\", \"LangfordCreekUpper\", \"WernerCreek\", \"CycloneCreekMiddle\", \"CoalCreekMiddle\", \"McGeeCreekUpper\"))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-37-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Snake River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndurationplotfun(bas = \"Snake River\", bigG = \"Pacific Creek at Moran NWIS\", months = c(7:9), wateryears = c(2021, 2022))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-38-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Yellowstone River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndurationplotfun(bas = \"Shields River\", bigG = \"Yellowstone River Livingston NWIS\", months = c(7:9), wateryears = c(2020, 2019), dropsites = c(\"Shields River Valley Ranch\", \"Buck Creek\", \"Lodgepole Creek\"))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-39-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Donner Blitzen\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndurationplotfun(bas = \"Donner Blitzen\", bigG = \"Donner Blitzen River nr Frenchglen NWIS\", months = c(7:9), wateryears = c(2022, 2020))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-40-1.png){width=960}\n:::\n:::\n\n\n\n\n\n:::\n\n\n#### Deficit\n\nShow total drought deficit (mm) relative to different low flow thresholds (derived from long-term Big G data) for each site during a relatively wet year and a dry year. Then, for each year, plot the relationship between the among site (little g's only) standard deviation of deficit and the low flow threshold used to calculate deficit\n\n::: panel-tabset\n##### West Brook\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeficitplotfun(bas = \"West Brook\", bigG = \"South River Conway NWIS\", months = c(7:9), wateryears = c(2020, 2021))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-41-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Staunton River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeficitplotfun(bas = \"Staunton River\", bigG = \"Rapidan River NWIS\", months = c(7:9), wateryears = c(2019, 2020))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-42-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Flathead\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeficitplotfun(bas = \"Flathead\", bigG = \"North Fork Flathead River NWIS\", months = c(7:9), wateryears = c(2020, 2021), dropsites = c(\"BigCreekLower\", \"LangfordCreekUpper\", \"WernerCreek\", \"CycloneCreekMiddle\", \"CoalCreekMiddle\", \"McGeeCreekUpper\"))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-43-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Snake River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeficitplotfun(bas = \"Snake River\", bigG = \"Pacific Creek at Moran NWIS\", months = c(7:9), wateryears = c(2021, 2022))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-44-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Yellowstone River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeficitplotfun(bas = \"Shields River\", bigG = \"Yellowstone River Livingston NWIS\", months = c(7:9), wateryears = c(2020, 2019), dropsites = c(\"Shields River Valley Ranch\", \"Buck Creek\", \"Lodgepole Creek\"))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-45-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Donner Blitzen\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeficitplotfun(bas = \"Donner Blitzen\", bigG = \"Donner Blitzen River nr Frenchglen NWIS\", months = c(7:9), wateryears = c(2022, 2020))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-46-1.png){width=960}\n:::\n:::\n\n\n\n\n\n:::\n\n\n### Site-level threshold\n\nOrganize data\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat_clean_sub_deficit <- dat_clean_sub %>%\n  mutate(deficit_50_fix = ifelse(z_Yield_mm < thresh_50_fix, abs(thresh_50_fix - z_Yield_mm), 0),\n         deficit_45_fix = ifelse(z_Yield_mm < thresh_45_fix, abs(thresh_45_fix - z_Yield_mm), 0),\n         deficit_40_fix = ifelse(z_Yield_mm < thresh_40_fix, abs(thresh_40_fix - z_Yield_mm), 0),\n         deficit_35_fix = ifelse(z_Yield_mm < thresh_35_fix, abs(thresh_35_fix - z_Yield_mm), 0),\n         deficit_30_fix = ifelse(z_Yield_mm < thresh_30_fix, abs(thresh_30_fix - z_Yield_mm), 0),\n         deficit_25_fix = ifelse(z_Yield_mm < thresh_25_fix, abs(thresh_25_fix - z_Yield_mm), 0),\n         deficit_20_fix = ifelse(z_Yield_mm < thresh_20_fix, abs(thresh_20_fix - z_Yield_mm), 0),\n         deficit_15_fix = ifelse(z_Yield_mm < thresh_15_fix, abs(thresh_15_fix - z_Yield_mm), 0),\n         deficit_10_fix = ifelse(z_Yield_mm < thresh_10_fix, abs(thresh_10_fix - z_Yield_mm), 0),\n         deficit_05_fix = ifelse(z_Yield_mm < thresh_05_fix, abs(thresh_05_fix - z_Yield_mm), 0),\n         deficit_02_fix = ifelse(z_Yield_mm < thresh_02_fix, abs(thresh_02_fix - z_Yield_mm), 0))\n\n# summarize by summer\ndefdur_ssn_sub <- dat_clean_sub_deficit %>% \n  filter(!is.na(Yield_mm), Month %in% c(7:9)) %>% \n  group_by(site_name, basin, subbasin, region, designation, CalendarYear, WaterYear) %>% \n  summarize(ndays = n(),\n            propdays = ndays/(31+31+30), \n            \n            duration_50_fix = sum(deficit_50_fix > 0),\n            duration_45_fix = sum(deficit_45_fix > 0),\n            duration_40_fix = sum(deficit_40_fix > 0),\n            duration_35_fix = sum(deficit_35_fix > 0),\n            duration_30_fix = sum(deficit_30_fix > 0),\n            duration_25_fix = sum(deficit_25_fix > 0),\n            duration_20_fix = sum(deficit_20_fix > 0),\n            duration_15_fix = sum(deficit_15_fix > 0),\n            duration_10_fix = sum(deficit_10_fix > 0),\n            duration_05_fix = sum(deficit_05_fix > 0),\n            duration_02_fix = sum(deficit_02_fix > 0),\n            \n            duration_50_fix_prop = sum(deficit_50_fix > 0) / ndays,\n            duration_45_fix_prop = sum(deficit_45_fix > 0) / ndays,\n            duration_40_fix_prop = sum(deficit_40_fix > 0) / ndays,\n            duration_35_fix_prop = sum(deficit_35_fix > 0) / ndays,\n            duration_30_fix_prop = sum(deficit_30_fix > 0) / ndays,\n            duration_25_fix_prop = sum(deficit_25_fix > 0) / ndays,\n            duration_20_fix_prop = sum(deficit_20_fix > 0) / ndays,\n            duration_15_fix_prop = sum(deficit_15_fix > 0) / ndays,\n            duration_10_fix_prop = sum(deficit_10_fix > 0) / ndays,\n            duration_05_fix_prop = sum(deficit_05_fix > 0) / ndays,\n            duration_02_fix_prop = sum(deficit_02_fix > 0) / ndays,\n            \n            deficit_50_fix = sum(deficit_50_fix),\n            deficit_45_fix = sum(deficit_45_fix),\n            deficit_40_fix = sum(deficit_40_fix),\n            deficit_35_fix = sum(deficit_35_fix),\n            deficit_30_fix = sum(deficit_30_fix),\n            deficit_25_fix = sum(deficit_25_fix),\n            deficit_20_fix = sum(deficit_20_fix),\n            deficit_15_fix = sum(deficit_15_fix),\n            deficit_10_fix = sum(deficit_10_fix),\n            deficit_05_fix = sum(deficit_05_fix),\n            deficit_02_fix = sum(deficit_02_fix)) %>%\n  ungroup() %>%\n  mutate(designation = ifelse(is.na(designation), \"big\", designation)) %>%\n  filter(propdays >= 0.70) %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield, totalyield_z))\n\n# keep raw days for binomial model\ndefdur_ssn_sub2 <- dat_clean_sub_deficit %>% \n  filter(!is.na(Yield_mm), Month %in% c(7:9)) %>% \n  group_by(site_name, basin, subbasin, region, designation, CalendarYear, WaterYear) %>% \n  summarize(ndays = n(),\n            propdays = ndays/(31+31+30), \n            duration_50_fix = sum(deficit_50_fix > 0),\n            duration_45_fix = sum(deficit_45_fix > 0),\n            duration_40_fix = sum(deficit_40_fix > 0),\n            duration_35_fix = sum(deficit_35_fix > 0),\n            duration_30_fix = sum(deficit_30_fix > 0),\n            duration_25_fix = sum(deficit_25_fix > 0),\n            duration_20_fix = sum(deficit_20_fix > 0),\n            duration_15_fix = sum(deficit_15_fix > 0),\n            duration_10_fix = sum(deficit_10_fix > 0),\n            duration_05_fix = sum(deficit_05_fix > 0),\n            duration_02_fix = sum(deficit_02_fix > 0),\n            \n            deficit_50_fix = sum(deficit_50_fix),\n            deficit_45_fix = sum(deficit_45_fix),\n            deficit_40_fix = sum(deficit_40_fix),\n            deficit_35_fix = sum(deficit_35_fix),\n            deficit_30_fix = sum(deficit_30_fix),\n            deficit_25_fix = sum(deficit_25_fix),\n            deficit_20_fix = sum(deficit_20_fix),\n            deficit_15_fix = sum(deficit_15_fix),\n            deficit_10_fix = sum(deficit_10_fix),\n            deficit_05_fix = sum(deficit_05_fix),\n            deficit_02_fix = sum(deficit_02_fix)) %>%\n  ungroup() %>%\n  mutate(designation = ifelse(is.na(designation), \"big\", designation)) %>%\n  filter(propdays >= 0.70) %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield, totalyield_z))\n```\n:::\n\n\n\n\n\n\nCreate plotting functions. These are the same as defined above, but instead grab the \"defdur_ssn_sub\" object for site-level low flow thresholds.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndurationplotfun_sub <- function(bas, bigG, months, wateryears, dropsites = NA) {\n  # filter and summarize data\n  dd <- defdur_ssn_sub %>% \n    filter(basin == bas | site_name == bigG, WaterYear %in% wateryears, !site_name %in% dropsites) %>%\n    mutate(WaterYear = factor(WaterYear, levels = wateryears))\n\n  # order sites, Big G first\n  mysites <- c(unique(unlist(dd %>% filter(designation == \"big\") %>% select(site_name))),\n               unique(unlist(dd %>% filter(designation == \"little\") %>% select(site_name))))\n\n  # among site StDev ~ percentile\n  p_sds <- dd %>% \n    gather(duration_50_fix_prop:duration_02_fix_prop, key = \"metric\", value = \"duration\") %>%\n    mutate(quant = as.numeric(gsub(\".*?([0-9]+).*\", \"\\\\1\", metric)) ) %>% \n    filter(designation == \"little\") %>%\n    group_by(WaterYear, totalyield_z, metric, quant) %>%\n    summarize(sddur = sd(duration, na.rm = TRUE)) %>%\n    ungroup() %>%\n    #left_join(dd %>% filter(site_name == bigG) %>% select(WaterYear, duration_25_fix_prop) %>% rename(dur25 = duration_25_fix_prop)) %>%\n    left_join(wateravail %>% filter(site_name == bigG) %>% select(WaterYear, tyz_sum_perc) %>% mutate(WaterYear = as.factor(WaterYear))) %>%\n    ggplot(aes(x = quant, y = sddur, color = tyz_sum_perc, group = WaterYear, shape = WaterYear)) +\n    stat_smooth() +\n    geom_point() +\n    scale_color_gradient(low = \"red\", high = \"blue\", limits = c(0,100)) +\n    xlab(\"Low flow threshold (percentile)\") + ylab(\"Among-site SD(duration)\") +\n    theme_bw() + \n    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),\n          legend.position = \"bottom\", legend.direction = \"vertical\", legend.key.height = unit(0.3, 'cm')) \n  \n  # barplot 50th perc\n  p30 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = duration_50_fix_prop)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,1) +\n    ylab(\"Days below low flow threshold (%JAS)\") + ggtitle(\"50th perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n  # barplot 25th perc.\n  p20 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = duration_25_fix_prop)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,1) +\n    ylab(\"Days below low flow threshold (%JAS)\") + ggtitle(\"25th perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n  # barplot 10th perc.\n  p10 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = duration_10_fix_prop)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,1) +\n    ylab(\"Days below low flow threshold (%JAS)\") + ggtitle(\"10th perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n  # barplot 5th perc.\n  p05 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = duration_05_fix_prop)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,1) +\n    ylab(\"Days below low flow threshold (%JAS)\") + ggtitle(\"5th perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n  # barplot 2nd perc\n  p02 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = duration_02_fix_prop)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,1) +\n    ylab(\"Days below low flow threshold (%JAS)\") + ggtitle(\"2nd perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n\n  # arrange plots\n  egg::ggarrange(p02 + theme(plot.margin = margin(r = 1, t = 5, b = 5)), \n                 p05 + theme(axis.text.y = element_blank(), axis.title.y = element_blank(), plot.margin = margin(r = 1, l = 1)), \n                 p10 + theme(axis.text.y = element_blank(), axis.title.y = element_blank(), plot.margin = margin(r = 1, l = 1)), \n                 p20 + theme(axis.text.y = element_blank(), axis.title.y = element_blank(), plot.margin = margin(r = 1, l = 1)), \n                 p30 + theme(axis.text.y = element_blank(), axis.title.y = element_blank(), plot.margin = margin(r = 1, l = 1)),\n                 p_sds,\n                 nrow = 1, widths = c(1,1,1,1,1,2.5))\n}\n\n\ndeficitplotfun_sub <- function(bas, bigG, months, wateryears, dropsites = NA) {\n  # filter and summarize data\n  dd_all <- defdur_ssn_sub %>% filter(basin == bas | site_name == bigG, WaterYear %in% wateryears, !site_name %in% dropsites) \n  dd <- defdur_ssn_sub %>% \n    filter(basin == bas | site_name == bigG, WaterYear %in% wateryears, !site_name %in% dropsites) %>%\n    mutate(WaterYear = factor(WaterYear, levels = wateryears))\n  \n  # get y-axis limit\n  ymax <- max(dd %>% select(deficit_50_fix:deficit_02_fix))\n\n  # order sites, Big G first\n  mysites <- c(unique(unlist(dd %>% filter(designation == \"big\") %>% select(site_name))),\n               unique(unlist(dd %>% filter(designation == \"little\") %>% select(site_name))))\n\n  # among site StDev ~ percentile\n  p_sds <- dd %>% \n    gather(deficit_50_fix:deficit_02_fix, key = \"metric\", value = \"deficit\") %>%\n    mutate(quant = as.numeric(gsub(\".*?([0-9]+).*\", \"\\\\1\", metric)) ) %>% \n    filter(designation == \"little\") %>%\n    group_by(WaterYear, totalyield_z, metric, quant) %>%\n    summarize(sddur = sd(deficit, na.rm = TRUE)) %>%\n    ungroup() %>%\n    #left_join(dd %>% filter(site_name == bigG) %>% select(WaterYear, deficit_25_fix) %>% rename(def25 = deficit_25_fix)) %>%\n    left_join(wateravail %>% filter(site_name == bigG) %>% select(WaterYear, tyz_sum_perc) %>% mutate(WaterYear = as.factor(WaterYear))) %>%\n    ggplot(aes(x = quant, y = sddur, color = tyz_sum_perc, group = WaterYear, shape = WaterYear)) +\n    stat_smooth() +\n    geom_point() +\n    scale_color_gradient(low = \"red\", high = \"blue\", limits = c(0,100)) +\n    xlab(\"Low flow threshold (percentile)\") + ylab(\"Among-site SD(deficit)\") +\n    theme_bw() + \n    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),\n          legend.position = \"bottom\", legend.direction = \"vertical\", legend.key.height = unit(0.3, 'cm'))\n  \n  # barplot 50th perc\n  p30 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = deficit_50_fix)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,ymax) +\n    ylab(\"Drought deficit (mm, JAS)\") + ggtitle(\"50th perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n  # barplot 25th perc.\n  p20 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = deficit_25_fix)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,ymax) +\n    ylab(\"Drought deficit (mm, JAS)\") + ggtitle(\"25th perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n  # barplot 10th perc.\n  p10 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = deficit_10_fix)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,ymax) +\n    ylab(\"Drought deficit (mm, JAS)\") + ggtitle(\"10th perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n  # barplot 5th perc.\n  p05 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = deficit_05_fix)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,ymax) +\n    ylab(\"Drought deficit (mm, JAS)\") + ggtitle(\"5th perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n  # barplot 2nd perc\n  p02 <- dd %>% \n    ggplot(aes(x = factor(site_name, levels = (mysites)), y = deficit_02_fix)) +\n    geom_bar(aes(fill = designation), stat = \"identity\") +\n    scale_fill_manual(values = c(\"grey20\", \"grey55\")) +\n    facet_wrap2(~WaterYear, ncol = 1, strip = strip_themed(background_x = elem_list_rect(fill = alpha(unique(layer_data(p_sds)[,1]), 0.5)))) +\n    ylim(0,ymax) +\n    ylab(\"Drought deficit (JAS)\") + ggtitle(\"2nd perc.\") +\n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n          legend.position = \"none\", axis.title.x = element_blank(),\n          panel.grid.major = element_blank(), panel.grid.minor = element_blank())\n\n  # arrange plots\n  egg::ggarrange(p02 + theme(plot.margin = margin(r = 1, t = 5, b = 5)), \n                 p05 + theme(axis.text.y = element_blank(), axis.title.y = element_blank(), plot.margin = margin(r = 1, l = 1)), \n                 p10 + theme(axis.text.y = element_blank(), axis.title.y = element_blank(), plot.margin = margin(r = 1, l = 1)), \n                 p20 + theme(axis.text.y = element_blank(), axis.title.y = element_blank(), plot.margin = margin(r = 1, l = 1)), \n                 p30 + theme(axis.text.y = element_blank(), axis.title.y = element_blank(), plot.margin = margin(r = 1, l = 1)),\n                 p_sds,\n                 nrow = 1, widths = c(1,1,1,1,1,2.5))\n}\n```\n:::\n\n\n\n\n\n\n#### Duration\n\nShow proportion of days (July - September) below different low flow thresholds (derived from temporally restricted, site-specific data) for each site during a relatively wet year and a dry year. Then, for each year, plot the relationship between the among site (little g's only) standard deviation of low flow duration and the low flow threshold used to calculate duration\n\n::: panel-tabset\n##### West Brook\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndurationplotfun_sub(bas = \"West Brook\", bigG = \"South River Conway NWIS\", months = c(7:9), wateryears = c(2022, 2020, 2021, 2023))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-49-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Staunton River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndurationplotfun_sub(bas = \"Staunton River\", bigG = \"Rapidan River NWIS\", months = c(7:9), wateryears = c(2019, 2022, 2021, 2020))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-50-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Flathead\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndurationplotfun_sub(bas = \"Flathead\", bigG = \"North Fork Flathead River NWIS\", months = c(7:9), wateryears = c(2019, 2021, 2020))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-51-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Snake River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndurationplotfun_sub(bas = \"Snake River\", bigG = \"Pacific Creek at Moran NWIS\", months = c(7:9), wateryears = c(2021, 2020, 2022))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-52-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Yellowstone River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndurationplotfun_sub(bas = \"Shields River\", bigG = \"Yellowstone River Livingston NWIS\", months = c(7:9), wateryears = c(2020, 2019, 2023, 2017), dropsites = c(\"Shields River Valley Ranch\", \"Buck Creek\", \"Lodgepole Creek\"))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-53-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Donner Blitzen\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndurationplotfun_sub(bas = \"Donner Blitzen\", bigG = \"Donner Blitzen River nr Frenchglen NWIS\", months = c(7:9), wateryears = c(2021,2020,2022, 2019))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-54-1.png){width=960}\n:::\n:::\n\n\n\n\n\n:::\n\n#### Deficit\n\nShow total drought deficit (mm) relative to different low flow thresholds (derived from long-term Big G data) for each site during a relatively wet year and a dry year. Then, for each year, plot the relationship between the among site (little g's only) standard deviation of deficit and the low flow threshold used to calculate deficit\n\n::: panel-tabset\n##### West Brook\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeficitplotfun_sub(bas = \"West Brook\", bigG = \"South River Conway NWIS\", months = c(7:9), wateryears = c(2022, 2020, 2021, 2023))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-55-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Staunton River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeficitplotfun_sub(bas = \"Staunton River\", bigG = \"Rapidan River NWIS\", months = c(7:9), wateryears = c(2019, 2022, 2021, 2020))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-56-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Flathead\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeficitplotfun_sub(bas = \"Flathead\", bigG = \"North Fork Flathead River NWIS\", months = c(7:9), wateryears = c(2019, 2021, 2020))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-57-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Snake River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeficitplotfun_sub(bas = \"Snake River\", bigG = \"Pacific Creek at Moran NWIS\", months = c(7:9), wateryears = c(2021, 2020, 2022))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-58-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Yellowstone River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeficitplotfun_sub(bas = \"Shields River\", bigG = \"Yellowstone River Livingston NWIS\", months = c(7:9), wateryears = c(2020, 2019, 2023, 2017), dropsites = c(\"Shields River Valley Ranch\", \"Buck Creek\", \"Lodgepole Creek\"))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-59-1.png){width=960}\n:::\n:::\n\n\n\n\n\n##### Donner Blitzen\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeficitplotfun_sub(bas = \"Donner Blitzen\", bigG = \"Donner Blitzen River nr Frenchglen NWIS\", months = c(7:9), wateryears = c(2021,2020,2022, 2019))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-60-1.png){width=960}\n:::\n:::\n\n\n\n\n\n:::\n\n\n### Summary plots\n\nWhat is the relationship between regional water availability (total summer flow percentile from long-term big G flow data) and spatial variation in little g drought duration and deficit?\n\nHypothesis: spatial variation in drought duration and deficit increases in dry years as controls on little G streamflow shift from regional to local (catchment) scales. (This follows directly from objective 1, but specifically considers low flow conditions).\n\n#### Fixed threshold\n\nFirst, using drought as defined from fixed thresholds (low flow thresholds derived from long-term big G records are applied to each little G)\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndefdur_ssn2 <- defdur_ssn %>% \n  filter(designation == \"little\", basin != \"Paine Run\") %>%\n  # left_join(defdur_ssn_sub %>% \n  #             filter(designation == \"little\") %>%\n  #             select(site_name, basin, WaterYear) %>%\n  #             group_by(basin, WaterYear) %>%\n  #             ungroup() %>%\n  #             mutate(nsites = length(unique(site_name)))) %>%\n  # filter(nsites >= 0) %>%\n  mutate(basin = ifelse(basin == \"Shields River\", \"Yellowstone River\",\n                        ifelse(basin == \"Flathead\", \"Flathead River\", \n                               ifelse(basin == \"Donner Blitzen\", \"Donner-Blitzen River\", basin)))) %>%\n  mutate(basin = factor(basin, levels = c(\"West Brook\", \"Staunton River\", \"Flathead River\", \"Yellowstone River\", \"Snake River\", \"Donner-Blitzen River\")))\n\nwateravail2 <- wateravail %>% \n  mutate(basin = ifelse(basin == \"Shields River\", \"Yellowstone River\",\n                        ifelse(basin == \"Flathead\", \"Flathead River\",  \n                               ifelse(basin == \"Donner Blitzen\", \"Donner-Blitzen River\", basin)))) %>%\n  mutate(basin = factor(basin, levels = c(\"West Brook\", \"Piney River\", \"Staunton River\", \"Paine Run\", \"Flathead River\", \"Yellowstone River\", \"Snake River\", \"Donner-Blitzen River\")))\n```\n:::\n\n\n\n\n\n\n::: panel-tabset\n##### Duration: basins combined\n\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-62-1.png){width=672}\n:::\n:::\n\n\n\n\n\n##### Duration: by basin\n\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-63-1.png){width=672}\n:::\n:::\n\n\n\n\n\n##### Deficit: basins combined\n\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-64-1.png){width=672}\n:::\n:::\n\n\n\n\n\n##### Deficift: by basin\n\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-65-1.png){width=672}\n:::\n:::\n\n\n\n\n\n:::\n\nSummarize relationships across thresholds: how does the definition of \"low flow\"/\"drought\" change the way we understand the effect of regional water availability on spatial variation in low flow conditions?\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolnums <- c(8:18)\neffecttib <- tibble(threshold = rep(NA, times = length(colnums)),\n                    int_est = rep(NA, times = length(colnums)),\n                    int_se = rep(NA, times = length(colnums)),\n                    slo_est = rep(NA, times = length(colnums)),\n                    slo_se = rep(NA, times = length(colnums)))\n\nfor (i in 1:length(colnums)) {\n  effecttib$threshold[i] <- parse_number(names(defdur_ssn2)[colnums[i]+2])\n  dd <- defdur_ssn2 %>%\n    filter(designation == \"little\", ndays >= 87) %>%\n    group_by(basin, WaterYear) %>%\n    summarize(n = n()) %>%\n    ungroup() %>%\n    left_join(defdur_ssn2 %>%\n                filter(designation == \"little\", ndays >= 87) %>%\n                group_by(basin, WaterYear) %>%\n                summarize_at(colnums[i], funs(min, max)) %>%\n                ungroup()) %>%\n    mutate(rangedur = max-min) %>%\n    left_join(wateravail2 %>% select(basin, WaterYear, tyz_sum_perc)) #%>%\n    #rename(sddur = 4)\n  mymod <- summary(lm(rangedur ~ tyz_sum_perc, data = dd, weights = n))\n  effecttib$int_est[i] <- mymod$coefficients[1,1]\n  effecttib$int_se[i] <- mymod$coefficients[1,2]\n  effecttib$slo_est[i] <- mymod$coefficients[2,1]\n  effecttib$slo_se[i] <- mymod$coefficients[2,2]\n}\n\np1 <- effecttib %>%\n  ggplot(aes(x = threshold, y = int_est)) +\n  geom_line(color = \"grey\") +\n  geom_point() + \n  geom_errorbar(aes(ymin = int_est-int_se, ymax = int_est+int_se), width = 1) +\n  geom_abline(intercept = 0, slope = 0, linetype = \"dashed\") +\n  xlab(\"Low flow threshold (percentile)\") + ylab(\"Intercept (spatial variation at\\n0% regional water availability)\") +\n  theme_classic()\n\np2 <- effecttib %>%\n  ggplot(aes(x = threshold, y = slo_est)) +\n  geom_line(color = \"grey\") +\n  geom_point() + \n  geom_errorbar(aes(ymin = slo_est-slo_se, ymax = slo_est+slo_se), width = 1) +\n  geom_abline(intercept = 0, slope = 0, linetype = \"dashed\") +\n  xlab(\"Low flow threshold (percentile)\") + ylab(\"Slope (effect of regional water\\navailability on spatial variation)\") +\n  theme_classic()\n\negg::ggarrange(p1, p2, nrow = 2)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-66-1.png){width=384}\n:::\n:::\n\n\n\n\n\n\n\n#### Site-level threshold\n\nSecond, using drought as defined from site-specific thresholds (low flow thresholds derived for each site individually)\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndefdur_ssn_sub2 <- defdur_ssn_sub %>%\n  mutate(basin = ifelse(basin == \"Shields River\", \"Yellowstone River\",\n                        ifelse(basin == \"Flathead\", \"Flathead River\", \n                               ifelse(basin == \"Donner Blitzen\", \"Donner-Blitzen River\", basin)))) %>%\n  mutate(basin = factor(basin, levels = c(\"West Brook\", \"Piney River\", \"Staunton River\", \"Paine Run\", \n                                          \"Flathead River\", \"Yellowstone River\", \"Snake River\", \"Donner-Blitzen River\")))\n```\n:::\n\n\n\n\n\n\n::: panel-tabset\n##### Duration: basins combined\n\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-68-1.png){width=672}\n:::\n:::\n\n\n\n\n\n##### Duration: by basin\n\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-69-1.png){width=672}\n:::\n:::\n\n\n\n\n\n##### Deficit: basins combined\n\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-70-1.png){width=672}\n:::\n:::\n\n\n\n\n\n##### Deficit: by basin\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- defdur_ssn_sub %>%\n  filter(designation == \"little\") %>%\n  group_by(basin, WaterYear) %>%\n  summarize(sddur = sd(deficit_02_fix)) %>%\n  ungroup() %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield:tyz_sum_perc)) %>%\n  ggplot(aes(x = tyz_sum_perc, y = sddur, color = basin)) +\n  geom_smooth(method = \"lm\", se = FALSE) +\n  geom_point(aes(color = basin)) +\n  #facet_wrap(~basin) +\n  annotate(\"text\", label = \"2nd perc.\", x = Inf, y = Inf, hjust = 1, vjust = 1) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.title = element_blank(), axis.text.x = element_blank(), legend.position = \"none\") + \n  ylim(0,6)\n\np2 <- defdur_ssn_sub %>%\n  filter(designation == \"little\") %>%\n  group_by(basin, WaterYear) %>%\n  summarize(sddur = sd(deficit_05_fix)) %>%\n  ungroup() %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield:tyz_sum_perc)) %>%\n  ggplot(aes(x = tyz_sum_perc, y = sddur, color = basin)) +\n  geom_smooth(method = \"lm\", se = FALSE) +\n  geom_point(aes(color = basin)) +\n  #facet_wrap(~basin) +\n  annotate(\"text\", label = \"5th perc.\", x = Inf, y = Inf, hjust = 1, vjust = 1) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.title = element_blank(), axis.text = element_blank()) + ylim(0,6)\n\np3 <- defdur_ssn_sub %>%\n  filter(designation == \"little\") %>%\n  group_by(basin, WaterYear) %>%\n  summarize(sddur = sd(deficit_10_fix)) %>%\n  ungroup() %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield:tyz_sum_perc)) %>%\n  ggplot(aes(x = tyz_sum_perc, y = sddur, color = basin)) +\n  geom_smooth(method = \"lm\", se = FALSE) +\n  geom_point(aes(color = basin)) +\n  #facet_wrap(~basin) +\n  annotate(\"text\", label = \"10th perc.\", x = Inf, y = Inf, hjust = 1, vjust = 1) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.title = element_blank(), legend.position = \"none\") + ylim(0,6)\n\np4 <- defdur_ssn_sub %>%\n  filter(designation == \"little\") %>%\n  group_by(basin, WaterYear) %>%\n  summarize(sddur = sd(deficit_20_fix)) %>%\n  ungroup() %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield:tyz_sum_perc)) %>%\n  ggplot(aes(x = tyz_sum_perc, y = sddur, color = basin)) +\n  geom_smooth(method = \"lm\", se = FALSE) +\n  geom_point(aes(color = basin)) +\n  #facet_wrap(~basin) +\n  annotate(\"text\", label = \"20th perc.\", x = Inf, y = Inf, hjust = 1, vjust = 1) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.title = element_blank(), axis.text.y = element_blank(), legend.position = \"none\") + ylim(0,6)\n\nannotate_figure(egg::ggarrange(p1, p2, p3, p4), \n                left = \"Among-site variation in drought deficit (SD)\", bottom = \"Regional water availability (percentile)\")\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-71-1.png){width=672}\n:::\n:::\n\n\n\n\n\n:::\n\n\nSummarize relationships across thresholds: how does the definition of \"low flow\"/\"drought\" change the way we understand the effect of regional water availability on spatial variation in low flow conditions?\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolnums <- c(8:18)\neffecttib <- tibble(threshold = rep(NA, times = length(colnums)),\n                    int_est = rep(NA, times = length(colnums)),\n                    int_se = rep(NA, times = length(colnums)),\n                    slo_est = rep(NA, times = length(colnums)),\n                    slo_se = rep(NA, times = length(colnums)))\n\nfor (i in 1:length(colnums)) {\n  effecttib$threshold[i] <- parse_number(names(defdur_ssn_sub2)[colnums[i]+2])\n  dd <- defdur_ssn_sub2 %>%\n    filter(designation == \"little\", ndays >= 87) %>%\n    group_by(basin, WaterYear) %>%\n    summarize(n = n()) %>%\n    ungroup() %>%\n    left_join(defdur_ssn_sub2 %>%\n                filter(designation == \"little\", ndays >= 87) %>%\n                group_by(basin, WaterYear) %>%\n                summarize_at(colnums[i], funs(min, max)) %>%\n                ungroup()) %>%\n    mutate(rangedur = max-min) %>%\n    left_join(wateravail2 %>% select(basin, WaterYear, tyz_sum_perc)) #%>%\n    #rename(sddur = 4)\n  mymod <- summary(lm(rangedur ~ tyz_sum_perc, data = dd, weights = n))\n  effecttib$int_est[i] <- mymod$coefficients[1,1]\n  effecttib$int_se[i] <- mymod$coefficients[1,2]\n  effecttib$slo_est[i] <- mymod$coefficients[2,1]\n  effecttib$slo_se[i] <- mymod$coefficients[2,2]\n}\n\np1 <- effecttib %>%\n  ggplot(aes(x = threshold, y = int_est)) +\n  geom_line(color = \"grey\") +\n  geom_point() + \n  geom_errorbar(aes(ymin = int_est-int_se, ymax = int_est+int_se), width = 1) +\n  geom_abline(intercept = 0, slope = 0, linetype = \"dashed\") +\n  xlab(\"Low flow threshold (percentile)\") + ylab(\"Intercept (spatial variation at\\n0% regional water availability)\") +\n  theme_classic()\n\np2 <- effecttib %>%\n  ggplot(aes(x = threshold, y = slo_est)) +\n  geom_line(color = \"grey\") +\n  geom_point() + \n  geom_errorbar(aes(ymin = slo_est-slo_se, ymax = slo_est+slo_se), width = 1) +\n  geom_abline(intercept = 0, slope = 0, linetype = \"dashed\") +\n  xlab(\"Low flow threshold (percentile)\") + ylab(\"Slope (effect of regional water\\navailability on spatial variation)\") +\n  theme_classic()\n\negg::ggarrange(p1, p2, nrow = 2)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-72-1.png){width=384}\n:::\n:::\n\n\n\n\n\n\n\n## Model drought agreement\n\nHow suitable are reference gages for predicting low flow conditions in headwater stream networks? \n\n* Calculate the difference between low flow duration at little g's versus that at big G and model the relationship between these differences and basin-specific annual water availability to understand how reference gage suitability may change with regional climatic context\n* Include effects of water availability on the regression uncertainty (sigma) to evaluate how spatial heterogeneity in low flow conditions changes with regional water availability. \n  + Calculate attenuation strength (the ratio between model standard deviation in dry versus wet years, sensu Chezik *et al.* 2017) to describe the degree to which spatial variation in low flow conditions changes with annual water availability\n* Include random effects for basin to account for basin-level differences in the primary (and sigma?) relationship\n* Iteratively fit the model to data derived from a range of critical low flow thresholds to evaluate how the definition of low flows/drought affects inferences\n\n\n### Data manipulation and plots\n\nCalculate difference in drought duration between headwaters gages and reference gage\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndefdur_ssn_sub2_little <- defdur_ssn_sub2 %>% filter(designation == \"little\")\ndefdur_ssn_sub2_big <- defdur_ssn_sub2 %>% filter(designation == \"big\") %>% select(basin, WaterYear, ndays, duration_50_fix:duration_02_fix)\nnames(defdur_ssn_sub2_big) <- c(\"basin\", \"WaterYear\", \"ndays_big\", \"duration_50_fix_big\", \"duration_45_fix_big\", \"duration_40_fix_big\", \"duration_35_fix_big\", \"duration_30_fix_big\", \"duration_25_fix_big\", \"duration_20_fix_big\", \"duration_15_fix_big\", \"duration_10_fix_big\", \"duration_05_fix_big\", \"duration_02_fix_big\")\n\njoineddefdur <- defdur_ssn_sub2_little %>% left_join(defdur_ssn_sub2_big) %>%\n  mutate(ndays_diff = ndays - ndays_big,\n         duration_50_fix_diff = duration_50_fix - duration_50_fix_big,\n         duration_45_fix_diff = duration_45_fix - duration_45_fix_big,\n         duration_40_fix_diff = duration_40_fix - duration_40_fix_big,\n         duration_35_fix_diff = duration_35_fix - duration_35_fix_big,\n         duration_30_fix_diff = duration_30_fix - duration_30_fix_big,\n         duration_25_fix_diff = duration_25_fix - duration_25_fix_big,\n         duration_20_fix_diff = duration_20_fix - duration_20_fix_big,\n         duration_15_fix_diff = duration_15_fix - duration_15_fix_big,\n         duration_10_fix_diff = duration_10_fix - duration_10_fix_big,\n         duration_05_fix_diff = duration_05_fix - duration_05_fix_big,\n         duration_02_fix_diff = duration_02_fix - duration_02_fix_big) %>%\n  left_join(wateravail2 %>% select(basin, WaterYear, totalyield:tyz_sum_perc))\n\njoineddefdur <- joineddefdur %>% mutate(basin_num = as.numeric(basin))\n\njoineddefdur %>% group_by(basin) %>% summarize(basin_num = unique(basin_num))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 2\n  basin                basin_num\n  <fct>                    <dbl>\n1 West Brook                   1\n2 Staunton River               3\n3 Flathead River               5\n4 Yellowstone River            6\n5 Snake River                  7\n6 Donner-Blitzen River         8\n```\n\n\n:::\n:::\n\n\n\n\n\n\nPlot difference in drought duration by regional water availability for 4 low flow thresholds\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- joineddefdur %>%\n  mutate(groups = paste(basin, WaterYear, sep = \"_\")) %>% \n  ggplot(aes(x = tyz_sum_perc, y = duration_10_fix_diff)) +\n  # geom_quantile(quantiles = c(0.05, 0.5, 0.95)) +\n  geom_point(aes(fill = basin), shape = 21, size = 2, position = position_jitter(seed = 1, width = 1)) +\n  scale_fill_manual(values = mycols) +\n  theme_bw() + theme(panel.grid = element_blank()) + ylim(-60,60)\n\np2 <- joineddefdur %>%\n  mutate(groups = paste(basin, WaterYear, sep = \"_\")) %>% \n  ggplot(aes(x = tyz_sum_perc, y = duration_20_fix_diff)) +\n  # geom_quantile(quantiles = c(0.05, 0.5, 0.95)) +\n  geom_point(aes(fill = basin), shape = 21, size = 2, position = position_jitter(seed = 1, width = 1)) +\n  scale_fill_manual(values = mycols) +\n  theme_bw() + theme(panel.grid = element_blank()) + ylim(-60,60)\n\np3 <- joineddefdur %>%\n  mutate(groups = paste(basin, WaterYear, sep = \"_\")) %>% \n  ggplot(aes(x = tyz_sum_perc, y = duration_30_fix_diff)) +\n  # geom_quantile(quantiles = c(0.05, 0.5, 0.95)) +\n  geom_point(aes(fill = basin), shape = 21, size = 2, position = position_jitter(seed = 1, width = 1)) +\n  scale_fill_manual(values = mycols) +\n  theme_bw() + theme(panel.grid = element_blank()) + ylim(-60,60)\n\np4 <- joineddefdur %>%\n  mutate(groups = paste(basin, WaterYear, sep = \"_\")) %>% \n  ggplot(aes(x = tyz_sum_perc, y = duration_40_fix_diff)) +\n  # geom_quantile(quantiles = c(0.05, 0.5, 0.95)) +\n  geom_point(aes(fill = basin), shape = 21, size = 2, position = position_jitter(seed = 1, width = 1)) +\n  scale_fill_manual(values = mycols) +\n  theme_bw() + theme(panel.grid = element_blank()) + ylim(-60,60)\n\nggarrange(p1, p2, p3, p4, nrow = 2, ncol = 2, common.legend = TRUE, legend = \"right\")\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-74-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n### Specify JAGS model\n\nSpecify ~simple JAGS model: linear regression between regional water availability and low flow duration, where sigma is modeled as a function of regional water availability\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"model {\n\n##--- LIKELIHOOD ---------------------------------------------------##\n\nfor (i in 1:nObs) {\n\n  D[i] ~ dnorm(mu[i], pow(sigma[i], -2))\n  mu[i] <- alpha + beta * W[i]\n  log(sigma[i]) <- sig.alpha + sig.beta * W[i]\n  \n  # Log-likelihood\n  loglik[i] <- logdensity.norm(D[i], mu[i], pow(sigma[i], -2))\n  }\n\n\n##--- PRIORS --------------------------------------------------------##\n\nalpha ~ dnorm(0, pow(10, -2))\nbeta ~ dnorm(0, pow(10, -2))\nsig.alpha ~ dnorm(0, pow(10, -2))\nsig.beta ~ dnorm(0, pow(10, -2))\n\n\n##--- DERIVED VALUES ------------------------------------------------##\n\n# attenuation strength\nAS <- exp(sig.alpha + sig.beta * 0) / exp(sig.alpha + sig.beta * 100)\n\n# predictions\nfor (i in 1:nPreds) {\n    P[i] ~ dnorm(alpha + beta * Wp[i], pow(exp(sig.alpha + sig.beta * Wp[i]), -2))\n}\n\n}\", file = \"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/DroughtModel.txt\")\n```\n:::\n\n\n\n\n\n\nAdd random effect of basin to primary relationship\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"model {\n\n##--- LIKELIHOOD ---------------------------------------------------##\n\nfor (i in 1:nObs) {\n\n  D[i] ~ dnorm(mu[i], pow(sigma[i], -2))\n  mu[i] <- alpha[basins[i]] + beta[basins[i]] * W[i]\n  log(sigma[i]) <- sig.alpha + sig.beta * W[i]\n  \n  # Log-likelihood\n  loglik[i] <- logdensity.norm(D[i], mu[i], pow(sigma[i], -2))\n  }\n\n\n##--- RANDOM EFFECTS ------------------------------------------------##\n\nfor (j in numBasins) {\n    alpha[j] ~ dnorm(mu.alpha, pow(sigma.alpha, -2)) \n    beta[j] ~ dnorm(mu.beta, pow(sigma.beta, -2)) \n}\n    \n\n##--- PRIORS --------------------------------------------------------##\n\nmu.alpha ~ dnorm(0, pow(10, -2))\nmu.beta ~ dnorm(0, pow(10, -2))\nsigma.alpha ~ dunif(0, 100)\nsigma.beta ~ dunif(0, 100)\n\nsig.alpha ~ dnorm(0, pow(10, -2))\nsig.beta ~ dnorm(0, pow(10, -2))\n\n\n##--- DERIVED VALUES ------------------------------------------------##\n\n# attenuation strength\nAS <- exp(sig.alpha + sig.beta * 0) / exp(sig.alpha + sig.beta * 100)\n\n# predictions\nfor (i in 1:nPreds) {\n    P1[i] ~ dnorm(alpha[1] + beta[1] * Wp[i], pow(exp(sig.alpha + sig.beta * Wp[i]), -2))\n    P3[i] ~ dnorm(alpha[3] + beta[3] * Wp[i], pow(exp(sig.alpha + sig.beta * Wp[i]), -2))\n    P5[i] ~ dnorm(alpha[5] + beta[5] * Wp[i], pow(exp(sig.alpha + sig.beta * Wp[i]), -2))\n    P6[i] ~ dnorm(alpha[6] + beta[6] * Wp[i], pow(exp(sig.alpha + sig.beta * Wp[i]), -2))\n    P7[i] ~ dnorm(alpha[7] + beta[7] * Wp[i], pow(exp(sig.alpha + sig.beta * Wp[i]), -2))\n    P8[i] ~ dnorm(alpha[8] + beta[8] * Wp[i], pow(exp(sig.alpha + sig.beta * Wp[i]), -2))\n}\n\n}\", file = \"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/DroughtModel_REmain.txt\")\n```\n:::\n\n\n\n\n\n\nAdd random effect of basin to sigma relationship\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"model {\n\n##--- LIKELIHOOD ---------------------------------------------------##\n\nfor (i in 1:nObs) {\n\n  D[i] ~ dnorm(mu[i], pow(sigma[i], -2))\n  mu[i] <- alpha[basins[i]] + beta[basins[i]] * W[i]\n  log(sigma[i]) <- sig.alpha[basins[i]] + sig.beta[basins[i]] * W[i]\n  }\n\n\n##--- RANDOM EFFECTS ------------------------------------------------##\n\nfor (j in numBasins) {\n    alpha[j] ~ dnorm(mu.alpha, pow(5, -2)) \n    beta[j] ~ dnorm(mu.beta, pow(5, -2)) \n\n    sig.alpha[j] ~ dnorm(mu.sig.alpha, pow(5, -2)) \n    sig.beta[j] ~ dnorm(mu.sig.beta, pow(5, -2)) \n}\n    \n\n##--- PRIORS --------------------------------------------------------##\n\nmu.alpha ~ dnorm(0, pow(10, -2))\nmu.beta ~ dnorm(0, pow(10, -2))\n\nmu.sig.alpha ~ dnorm(0, pow(10, -2))\nmu.sig.beta ~ dnorm(0, pow(10, -2))\n#sigma.sig.alpha ~ dunif(0.0001, 100)\n#sigma.sig.beta ~ dunif(0.0001, 100)\n\n\n##--- DERIVED VALUES ------------------------------------------------##\n\n# attenuation strength\n#AS <- exp(mu.sig.alpha + mu.sig.beta * 0) / exp(mu.sig.alpha + mu.sig.beta * 100)\n\n}\", file = \"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/DroughtModel_REsigma.txt\")\n```\n:::\n\n\n\n\n\n\n\n### Fit models\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodlist <- list()\nnpreds <- 101\nthresh <- c(50,45,40,35,30,25,20,15,10,5,2)\n\n# simple\njags.data <- list(\"nObs\" = dim(joineddefdur)[1] + npreds, \n                  \"D\" = c(unlist(joineddefdur[,57+8]), rep(NA, times = npreds)), \n                  \"W\" = c(joineddefdur$tyz_sum_perc, seq(from = 0, to = 100, by = 1)))\n\njags.data <- list(\"nObs\" = dim(joineddefdur)[1], \n                  \"D\" = unlist(joineddefdur[,57+8]), \n                  \"W\" = joineddefdur$tyz_sum_perc,\n                  \"nPreds\" = npreds, \"Wp\" = seq(from = 0, to = 100, length.out = npreds))\n\njags.params <- c(\"alpha\", \"beta\", \"sig.alpha\", \"sig.beta\", \"AS\", \"D\", \"P\", \"loglik\")\nfit_simple <- jags(data = jags.data, parameters.to.save = jags.params,\n                   model.file = \"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/DroughtModel.txt\",\n                   n.chains = 3, n.thin = 10, n.burnin = 1000, n.iter = 6000, DIC = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCompiling model graph\n   Resolving undeclared variables\n   Allocating nodes\nGraph information:\n   Observed stochastic nodes: 163\n   Unobserved stochastic nodes: 105\n   Total graph size: 1250\n\nInitializing model\n```\n\n\n:::\n\n```{.r .cell-code}\n# random effects main\njags.data <- list(\"nObs\" = dim(joineddefdur)[1], \"D\" = unlist(joineddefdur[,57+8]), \"W\" = joineddefdur$tyz_sum_perc,\n                  \"nPreds\" = npreds, \"Wp\" = seq(from = 0, to = 100, length.out = npreds),\n                  \"basins\" = joineddefdur$basin_num, \"numBasins\" = c(1,3,5,6,7,8))\njags.params <- c(\"alpha\", \"beta\", \"mu.alpha\", \"sigma.alpha\", \"mu.beta\", \"sigma.beta\", \"sig.alpha\", \"sig.beta\", \"AS\", \"D\", \"P1\", \"P3\", \"P5\", \"P6\", \"P7\", \"P8\", \"loglik\")\nfit_remain <- jags(data = jags.data, parameters.to.save = jags.params,\n                   model.file = \"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/DroughtModel_REmain.txt\",\n                   n.chains = 3, n.thin = 20, n.burnin = 2000, n.iter = 17000, DIC = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCompiling model graph\n   Resolving undeclared variables\n   Allocating nodes\nGraph information:\n   Observed stochastic nodes: 163\n   Unobserved stochastic nodes: 624\n   Total graph size: 2950\n\nInitializing model\n```\n\n\n:::\n\n```{.r .cell-code}\nfit_remain$BUGSoutput$summary[,8][fit_remain$BUGSoutput$summary[,8] > 1.02]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nnamed numeric(0)\n```\n\n\n:::\n\n```{.r .cell-code}\n# random effects sigma\njags.data <- list(\"nObs\" = dim(joineddefdur)[1], \n                  \"D\" = unlist(joineddefdur[,57+8]), \n                  \"W\" = joineddefdur$tyz_sum_perc,\n                  \"basins\" = joineddefdur$basin_num, \"numBasins\" = c(1,3,5,6,7,8))\njags.params <- c(\"mu.alpha\", \"mu.beta\", \"alpha\", \"beta\", \"mu.sig.alpha\", \"mu.sig.beta\", \"sig.alpha\", \"sig.beta\", \"D\")\nfit_resigma <- jags(data = jags.data, parameters.to.save = jags.params,\n                   model.file = \"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/DroughtModel_REsigma.txt\",\n                   n.chains = 3, n.thin = 10, n.burnin = 1000, n.iter = 6000, DIC = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCompiling model graph\n   Resolving undeclared variables\n   Allocating nodes\nGraph information:\n   Observed stochastic nodes: 163\n   Unobserved stochastic nodes: 28\n   Total graph size: 663\n\nInitializing model\n```\n\n\n:::\n:::\n\n\n\n\n\n\n### Traceplots\n\n#### Simple\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nMCMCtrace(fit_simple, ind = TRUE, params = c(\"alpha\", \"beta\", \"sig.alpha\", \"sig.beta\", \"AS\"), pdf = FALSE)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-79-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-79-2.png){width=672}\n:::\n:::\n\n\n\n\n\n\n#### Primary Random Effects\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nMCMCtrace(fit_remain, ind = TRUE, params = c(\"alpha\", \"beta\", \"mu.alpha\", \"mu.beta\", \"sig.alpha\", \"sig.beta\", \"AS\"), pdf = FALSE)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-80-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-80-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-80-3.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-80-4.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-80-5.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-80-6.png){width=672}\n:::\n:::\n\n\n\n\n\n\n#### Full Random Effects\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nMCMCtrace(fit_resigma, ind = TRUE, params = c(\"mu.alpha\", \"mu.beta\", \"alpha\", \"beta\", \"mu.sig.alpha\", \"mu.sig.beta\", \"sig.alpha\", \"sig.beta\", \"AS\"), pdf = FALSE)\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-81-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-81-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-81-3.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-81-4.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-81-5.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-81-6.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-81-7.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-81-8.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-81-9.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-81-10.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n### Plot\n\n#### Simple\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop_mod <- fit_simple\nmodelout <- top_mod$BUGSoutput\nMcmcList <- vector(\"list\", length = dim(modelout$sims.array)[2])\nfor(i in 1:length(McmcList)) { McmcList[[i]] = as.mcmc(modelout$sims.array[,i,]) }\nMcmcdat <- rbind(McmcList[[1]], McmcList[[2]], McmcList[[3]])\n\n# summarize lower and upper prediction intervales (attenuation)\nd_preds <- Mcmcdat[,grep(\"P\", colnames(Mcmcdat))]\npi_low1 <- apply(d_preds, 2, quantile, probs = c(0.025),  na.rm = TRUE)\npi_upp1 <- apply(d_preds, 2, quantile, probs = c(0.975),  na.rm = TRUE)\npi_med1 <- apply(d_preds, 2, quantile, probs = c(0.5),  na.rm = TRUE)\n\n# plot\nggplot() +\n  geom_ribbon(aes(x = seq(from = 0, to = 100, by = 1), ymin = pi_low1, ymax = pi_upp1), alpha = 0.3) +\n  geom_line(aes(x = seq(from = 0, to = 100, by = 1), y = pi_med1), size = 2) +\n  # geom_smooth(aes(x = seq(from = 0, to = 100, by = 1), y = pi_low), color = \"black\", size = 1.5) +\n  # geom_smooth(aes(x = seq(from = 0, to = 100, by = 1), y = pi_upp), color = \"black\", size = 1.5) +\n  geom_abline(intercept = 0, slope = 0, linetype = \"dashed\") +\n  geom_point(data = joineddefdur, aes(x = tyz_sum_perc, y = duration_20_fix_diff, fill = basin), \n             shape = 21, size = 2, position = position_jitter(seed = 1, width = 1)) +\n  scale_fill_manual(values = mycols) +\n  theme_bw() + theme(panel.grid = element_blank()) + #ylim(-60,60) +\n  xlab(\"Regional water availability (%)\") + ylab(\"Difference in low flow duration (days)\")\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-82-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n#### Primary Random Effect\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop_mod <- fit_remain\nmodelout <- top_mod$BUGSoutput\nMcmcList <- vector(\"list\", length = dim(modelout$sims.array)[2])\nfor(i in 1:length(McmcList)) { McmcList[[i]] = as.mcmc(modelout$sims.array[,i,]) }\nMcmcdat <- rbind(McmcList[[1]], McmcList[[2]], McmcList[[3]])\n\n# summarize lower and upper prediction intervales (attenuation)\nd_preds <- Mcmcdat[,grep(\"P1\", colnames(Mcmcdat))]\npi_low1 <- apply(d_preds, 2, quantile, probs = c(0.025),  na.rm = TRUE)\npi_upp1 <- apply(d_preds, 2, quantile, probs = c(0.975),  na.rm = TRUE)\npi_med1 <- apply(d_preds, 2, quantile, probs = c(0.5),  na.rm = TRUE)\n# summarize lower and upper prediction intervales (attenuation)\nd_preds <- Mcmcdat[,grep(\"P3\", colnames(Mcmcdat))]\npi_low3 <- apply(d_preds, 2, quantile, probs = c(0.025),  na.rm = TRUE)\npi_upp3 <- apply(d_preds, 2, quantile, probs = c(0.975),  na.rm = TRUE)\npi_med3 <- apply(d_preds, 2, quantile, probs = c(0.5),  na.rm = TRUE)\n# summarize lower and upper prediction intervales (attenuation)\nd_preds <- Mcmcdat[,grep(\"P5\", colnames(Mcmcdat))]\npi_low5 <- apply(d_preds, 2, quantile, probs = c(0.025),  na.rm = TRUE)\npi_upp5 <- apply(d_preds, 2, quantile, probs = c(0.975),  na.rm = TRUE)\npi_med5 <- apply(d_preds, 2, quantile, probs = c(0.5),  na.rm = TRUE)\n# summarize lower and upper prediction intervales (attenuation)\nd_preds <- Mcmcdat[,grep(\"P6\", colnames(Mcmcdat))]\npi_low6 <- apply(d_preds, 2, quantile, probs = c(0.025),  na.rm = TRUE)\npi_upp6 <- apply(d_preds, 2, quantile, probs = c(0.975),  na.rm = TRUE)\npi_med6 <- apply(d_preds, 2, quantile, probs = c(0.5),  na.rm = TRUE)\n# summarize lower and upper prediction intervales (attenuation)\nd_preds <- Mcmcdat[,grep(\"P7\", colnames(Mcmcdat))]\npi_low7 <- apply(d_preds, 2, quantile, probs = c(0.025),  na.rm = TRUE)\npi_upp7 <- apply(d_preds, 2, quantile, probs = c(0.975),  na.rm = TRUE)\npi_med7 <- apply(d_preds, 2, quantile, probs = c(0.5),  na.rm = TRUE)\n# summarize lower and upper prediction intervales (attenuation)\nd_preds <- Mcmcdat[,grep(\"P8\", colnames(Mcmcdat))]\npi_low8 <- apply(d_preds, 2, quantile, probs = c(0.025),  na.rm = TRUE)\npi_upp8 <- apply(d_preds, 2, quantile, probs = c(0.975),  na.rm = TRUE)\npi_med8 <- apply(d_preds, 2, quantile, probs = c(0.5),  na.rm = TRUE)\n\n# plot\nggplot() +\n  geom_ribbon(aes(x = seq(from = 0, to = 100, by = 1), ymin = pi_low1, ymax = pi_upp1), alpha = 0.3, fill = mycols[1]) +\n  geom_ribbon(aes(x = seq(from = 0, to = 100, by = 1), ymin = pi_low3, ymax = pi_upp3), alpha = 0.3, fill = mycols[3]) +\n  geom_ribbon(aes(x = seq(from = 0, to = 100, by = 1), ymin = pi_low5, ymax = pi_upp5), alpha = 0.3, fill = mycols[5]) +\n  geom_ribbon(aes(x = seq(from = 0, to = 100, by = 1), ymin = pi_low6, ymax = pi_upp6), alpha = 0.3, fill = mycols[6]) +\n  geom_ribbon(aes(x = seq(from = 0, to = 100, by = 1), ymin = pi_low7, ymax = pi_upp7), alpha = 0.3, fill = mycols[7]) +\n  geom_ribbon(aes(x = seq(from = 0, to = 100, by = 1), ymin = pi_low8, ymax = pi_upp8), alpha = 0.3, fill = mycols[8]) +\n  geom_line(aes(x = seq(from = 0, to = 100, by = 1), y = pi_med1), color = mycols[1], size = 2) +\n  geom_line(aes(x = seq(from = 0, to = 100, by = 1), y = pi_med3), color = mycols[3], size = 2) +\n  geom_line(aes(x = seq(from = 0, to = 100, by = 1), y = pi_med5), color = mycols[5], size = 2) +\n  geom_line(aes(x = seq(from = 0, to = 100, by = 1), y = pi_med6), color = mycols[6], size = 2) +\n  geom_line(aes(x = seq(from = 0, to = 100, by = 1), y = pi_med7), color = mycols[7], size = 2) +\n  geom_line(aes(x = seq(from = 0, to = 100, by = 1), y = pi_med8), color = mycols[8], size = 2) +\n  # geom_smooth(aes(x = seq(from = 0, to = 100, by = 1), y = pi_low), color = \"black\", size = 1.5) +\n  # geom_smooth(aes(x = seq(from = 0, to = 100, by = 1), y = pi_upp), color = \"black\", size = 1.5) +\n  geom_abline(intercept = 0, slope = 0, linetype = \"dashed\") +\n  geom_point(data = joineddefdur, aes(x = tyz_sum_perc, y = duration_20_fix_diff, fill = basin), \n             shape = 21, size = 2, position = position_jitter(seed = 1, width = 1)) +\n  scale_fill_manual(values = mycols) +\n  theme_bw() + theme(panel.grid = element_blank()) + #ylim(-60,60) +\n  xlab(\"Regional water availability (%)\") + ylab(\"Difference in low flow duration (days)\")\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-83-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n### Do not evaluate\n\nFit models for each threshold, in a loop\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodlist <- list()\nnpreds <- 101\nthresh <- c(50,45,40,35,30,25,20,15,10,5,2)\n\nfor (i in 1:11) {\n  names(joineddefdur)[57+i]\n  jags.data <- list(\"nObs\" = dim(joineddefdur)[1] + npreds, \n                    \"D\" = c(unlist(joineddefdur[,57+i]), rep(NA, times = npreds)), \n                    \"W\" = c(joineddefdur$tyz_sum_perc, seq(from = 0, to = 100, by = 1)))\n  jags.params <- c(\"alpha\", \"beta\", \"sig.alpha\", \"sig.beta\", \"AS\", \"D\", \"loglik\")\n  fit <- jags(data = jags.data, parameters.to.save = jags.params,\n              model.file = \"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/DroughtModel.txt\",\n              n.chains = 3, n.thin = 10, n.burnin = 1000, n.iter = 6000, DIC = FALSE)\n  modlist[[i]] <- fit\n}\n```\n:::\n\n\n\n\n\n\nGet attenuation strength (*sensu* Chezik et al. 2017) for each model (low flow threshold, %) and summarize as median and 95% credible interval\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nattenlist <- list()\nfor (i in 1:length(modlist)) { attenlist[[i]] <- modlist[[i]]$BUGSoutput$sims.list$AS }\nattentib <- tibble(threshold = rep(thresh, each = 1500), attenuation = unlist(attenlist))\n```\n:::\n\n\n\n\n\n\nPlot attenuation strength by low flow threshold\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nattentib_sum <- attentib %>% \n  group_by(threshold) %>% \n  summarize(median = quantile(attenuation, probs = 0.50),\n            cilow = quantile(attenuation, probs = 0.025),\n            ciupp = quantile(attenuation, probs = 0.975)) %>%\n  ungroup()\n\nattentib_sum %>%\n  ggplot() +\n  geom_abline(intercept = 1, slope = 0, linetype = \"dashed\", color = \"grey50\") +\n  geom_errorbar(aes(x = threshold, ymin = cilow, ymax = ciupp), width = 1) +\n  geom_point(aes(x = threshold, y = median)) +\n  theme_bw() + theme(panel.grid = element_blank()) + ylim(0,9) +\n  xlab(\"Low flow threshold (%)\") + ylab(\"Attenuation strength\")\n```\n:::\n\n\n\n\n\n\nSet top model as that with the greatest attenuation strength: 15% low flow threshold\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop_mod <- fit_remain\n```\n:::\n\n\n\n\n\n\nShow traceplots\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nMCMCtrace(top_mod, ind = TRUE, params = c(\"alpha\", \"beta\", \"sig.alpha\", \"sig.beta\", \"AS\"), pdf = FALSE)\n```\n:::\n\n\n\n\n\n\nGet MCMC samples and summary\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# generate MCMC samples and store as an array\nmodelout <- top_mod$BUGSoutput\nMcmcList <- vector(\"list\", length = dim(modelout$sims.array)[2])\nfor(i in 1:length(McmcList)) { McmcList[[i]] = as.mcmc(modelout$sims.array[,i,]) }\n# rbind MCMC samples from 10 chains \nMcmcdat <- rbind(McmcList[[1]], McmcList[[2]], McmcList[[3]])\nparam.summary <- modelout$summary\nhead(param.summary)\ndim(Mcmcdat)\n```\n:::\n\n\n\n\n\n\nShow LOO-CV tables and plot: model is well specified\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# get log-likelihoods\nloglik1 <- top_mod$BUGSoutput$sims.list$loglik[,c(1:163)]\nreff1 <- relative_eff(exp(loglik1), chain_id = c(rep(1,750), rep(2,750), rep(3,750)))\nloo1 <- loo(loglik1, r_eff = reff1)\nprint(loo1)\nplot(loo1)\n```\n:::\n\n\n\n\n\n\nPlot model output: attenuation of spatial heterogeneity in low flow duration with regional water availability\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get predictions\nd_preds <- Mcmcdat[,165:265]\n\n# summarize lower and upper prediction intervales (attenuation)\nd_preds <- Mcmcdat[,grep(\"P1\", colnames(Mcmcdat))]\npi_low1 <- apply(d_preds, 2, quantile, probs = c(0.025),  na.rm = TRUE)\npi_upp1 <- apply(d_preds, 2, quantile, probs = c(0.975),  na.rm = TRUE)\npi_med1 <- apply(d_preds, 2, quantile, probs = c(0.5),  na.rm = TRUE)\n# summarize lower and upper prediction intervales (attenuation)\nd_preds <- Mcmcdat[,grep(\"P3\", colnames(Mcmcdat))]\npi_low3 <- apply(d_preds, 2, quantile, probs = c(0.025),  na.rm = TRUE)\npi_upp3 <- apply(d_preds, 2, quantile, probs = c(0.975),  na.rm = TRUE)\npi_med3 <- apply(d_preds, 2, quantile, probs = c(0.5),  na.rm = TRUE)\n# summarize lower and upper prediction intervales (attenuation)\nd_preds <- Mcmcdat[,grep(\"P5\", colnames(Mcmcdat))]\npi_low5 <- apply(d_preds, 2, quantile, probs = c(0.025),  na.rm = TRUE)\npi_upp5 <- apply(d_preds, 2, quantile, probs = c(0.975),  na.rm = TRUE)\npi_med5 <- apply(d_preds, 2, quantile, probs = c(0.5),  na.rm = TRUE)\n# summarize lower and upper prediction intervales (attenuation)\nd_preds <- Mcmcdat[,grep(\"P6\", colnames(Mcmcdat))]\npi_low6 <- apply(d_preds, 2, quantile, probs = c(0.025),  na.rm = TRUE)\npi_upp6 <- apply(d_preds, 2, quantile, probs = c(0.975),  na.rm = TRUE)\npi_med6 <- apply(d_preds, 2, quantile, probs = c(0.5),  na.rm = TRUE)\n# summarize lower and upper prediction intervales (attenuation)\nd_preds <- Mcmcdat[,grep(\"P7\", colnames(Mcmcdat))]\npi_low7 <- apply(d_preds, 2, quantile, probs = c(0.025),  na.rm = TRUE)\npi_upp7 <- apply(d_preds, 2, quantile, probs = c(0.975),  na.rm = TRUE)\npi_med7 <- apply(d_preds, 2, quantile, probs = c(0.5),  na.rm = TRUE)\n# summarize lower and upper prediction intervales (attenuation)\nd_preds <- Mcmcdat[,grep(\"P8\", colnames(Mcmcdat))]\npi_low8 <- apply(d_preds, 2, quantile, probs = c(0.025),  na.rm = TRUE)\npi_upp8 <- apply(d_preds, 2, quantile, probs = c(0.975),  na.rm = TRUE)\npi_med8 <- apply(d_preds, 2, quantile, probs = c(0.5),  na.rm = TRUE)\n\n# plot\nggplot() +\n  geom_ribbon(aes(x = seq(from = 0, to = 100, by = 1), ymin = pi_low1, ymax = pi_upp1), alpha = 0.3, fill = mycols[1]) +\n  geom_ribbon(aes(x = seq(from = 0, to = 100, by = 1), ymin = pi_low3, ymax = pi_upp3), alpha = 0.3, fill = mycols[3]) +\n  geom_ribbon(aes(x = seq(from = 0, to = 100, by = 1), ymin = pi_low5, ymax = pi_upp5), alpha = 0.3, fill = mycols[5]) +\n  geom_ribbon(aes(x = seq(from = 0, to = 100, by = 1), ymin = pi_low6, ymax = pi_upp6), alpha = 0.3, fill = mycols[6]) +\n  geom_ribbon(aes(x = seq(from = 0, to = 100, by = 1), ymin = pi_low7, ymax = pi_upp7), alpha = 0.3, fill = mycols[7]) +\n  geom_ribbon(aes(x = seq(from = 0, to = 100, by = 1), ymin = pi_low8, ymax = pi_upp8), alpha = 0.3, fill = mycols[8]) +\n  geom_line(aes(x = seq(from = 0, to = 100, by = 1), y = pi_med1), color = mycols[1], size = 2) +\n  geom_line(aes(x = seq(from = 0, to = 100, by = 1), y = pi_med3), color = mycols[3], size = 2) +\n  geom_line(aes(x = seq(from = 0, to = 100, by = 1), y = pi_med5), color = mycols[5], size = 2) +\n  geom_line(aes(x = seq(from = 0, to = 100, by = 1), y = pi_med6), color = mycols[6], size = 2) +\n  geom_line(aes(x = seq(from = 0, to = 100, by = 1), y = pi_med7), color = mycols[7], size = 2) +\n  geom_line(aes(x = seq(from = 0, to = 100, by = 1), y = pi_med8), color = mycols[8], size = 2) +\n  # geom_smooth(aes(x = seq(from = 0, to = 100, by = 1), y = pi_low), color = \"black\", size = 1.5) +\n  # geom_smooth(aes(x = seq(from = 0, to = 100, by = 1), y = pi_upp), color = \"black\", size = 1.5) +\n  geom_abline(intercept = 0, slope = 0, linetype = \"dashed\") +\n  geom_point(data = joineddefdur, aes(x = tyz_sum_perc, y = duration_20_fix_diff, fill = basin), \n             shape = 21, size = 2, position = position_jitter(seed = 1, width = 1)) +\n  scale_fill_manual(values = mycols) +\n  theme_bw() + theme(panel.grid = element_blank()) + #ylim(-60,60) +\n  xlab(\"Regional water availability (%)\") + ylab(\"Difference in low flow duration (days)\")\n```\n:::\n\n\n\n\n\n\n\n\n\n\n##### Combined figure\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# site-level drought threshold\nbas <- \"West Brook\"\nmonths <- c(7:9)\nbigG <- \"South River Conway NWIS\"\n\ndd_wet <- dat_clean_sub %>% filter(basin == bas, month %in% months, WaterYear == 2021) %>% mutate(site_name = factor(site_name, levels = rev(c(bigG, wborder))))\ndd_dry <- dat_clean_sub %>% filter(basin == bas, month %in% months, WaterYear == 2020) %>% mutate(site_name = factor(site_name, levels = rev(c(bigG, wborder))))\n\nmysites <- unlist(unique(dd_wet$site_name))\n# dd <- dd %>% filter(site_name %in% mysites)\n\n# HEAT MAPS\nheat1 <- dd_dry %>%\n  ggplot() +\n  geom_tile(aes(x = date, y = site_name, fill = drought_fix)) +\n  scale_fill_viridis(option = \"A\", direction = -1, discrete = TRUE, limits = mydroughtlevels) +\n  xlab(\"Date\") + ylab(\"Site\") +\n  theme_bw() + theme(axis.title = element_blank(), panel.background = element_rect(fill = 'grey90'),\n                     panel.grid.major = element_blank(), panel.grid.minor = element_blank(), \n                     axis.text = element_text(color = \"black\"), legend.position = \"none\") +\n  geom_line(data = data.frame(x = c(min(dd_dry$date)-days(10), max(dd_dry$date)+days(10)), \n                              y = rep(2:length(mysites), each = 2)-0.5), \n            aes(x = x, y = y, group = y), color = \"grey70\") +\n  coord_cartesian(xlim = c(min(dd_dry$date), max(dd_dry$date))) +\n  scale_y_discrete(expand = c(0,0), labels = rev(c(\"Ref.\", 1:8))) + \n  scale_x_date(expand = c(0,0), breaks = as.Date(c(\"2020-07-01\", \"2020-08-01\", \"2020-09-01\", \"2020-09-30\")), \n               labels = c(\"Jul\", \"Aug\", \"Sep\", \"Oct\")) +\n  guides(fill = guide_legend(title = \"Drought\\nthreshold (%)\"))\n\nheat2 <- dd_wet %>%\n  ggplot() +\n  geom_tile(aes(x = date, y = site_name, fill = drought_fix)) +\n  scale_fill_viridis(option = \"A\", direction = -1, discrete = TRUE, limits = mydroughtlevels) +\n  xlab(\"Date\") + ylab(\"Site\") +\n  theme_bw() + theme(axis.title = element_blank(), panel.background = element_rect(fill = 'grey90'),\n                     panel.grid.major = element_blank(), panel.grid.minor = element_blank(),\n                     axis.text = element_text(color = \"black\"), legend.position = \"none\") +\n  geom_line(data = data.frame(x = c(min(dd_wet$date)-days(10), max(dd_wet$date)+days(10)), \n                              y = rep(2:length(mysites), each = 2)-0.5), \n            aes(x = x, y = y, group = y), color = \"grey70\") +\n  coord_cartesian(xlim = c(min(dd_wet$date), max(dd_wet$date))) +\n  scale_y_discrete(expand = c(0,0), labels = rev(c(\"Ref.\", 1:8))) + \n  scale_x_date(expand = c(0,0), breaks = as.Date(c(\"2021-07-01\", \"2021-08-01\", \"2021-09-01\", \"2021-09-30\")), \n               labels = c(\"Jul\", \"Aug\", \"Sep\", \"Oct\")) +\n  guides(fill = guide_legend(title = \"Drought\\nthreshold (%)\"))\n\nscatter <- ggplot() +\n  geom_ribbon(aes(x = seq(from = 0, to = 100, by = 1), ymin = pi_low, ymax = pi_upp), alpha = 0.3) +\n  geom_abline(intercept = 0, slope = 0, linetype = \"dashed\") +\n  geom_point(data = joineddefdur, aes(x = tyz_sum_perc, y = duration_20_fix_diff, fill = basin), \n             shape = 21, size = 2, position = position_jitter(seed = 1, width = 1)) +\n  scale_fill_manual(values = mycols) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\"), legend.position = \"none\") + \n  scale_x_continuous(breaks = seq(0,100,20), limits = c(-8,111)) +\n  xlab(\"Regional water availability (%)\") + ylab(\"Difference in low flow duration (days)\")\n\neffectplot <- attentib_sum %>%\n  ggplot() +\n  geom_abline(intercept = 1, slope = 0, linetype = \"dashed\", color = \"grey50\") +\n  geom_errorbar(aes(x = threshold, ymin = cilow, ymax = ciupp), width = 1) +\n  geom_point(aes(x = threshold, y = median), shape = 21, fill = \"white\", size = 2) +\n  geom_point(data = attentib_sum %>% filter(threshold == 15), \n             aes(x = threshold, y = median), size = 2) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\")) + ylim(0,9) +\n  xlab(\"Low flow threshold (%)\") + ylab(expression(paste(\"Attenuation strength (\", sigma[0], \" / \",  sigma[100], \")\", sep = \"\")))\n\n\njpeg(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/Presentation figs/DroughtDuration_sitelevel_WestBrook_2020-2021.jpg\", width = 6.5, height = 6.5, units = \"in\", res = 1000)\negg::ggarrange(heat1, scatter, heat2, effectplot, nrow = 2, ncol = 2)\ndev.off()\n```\n:::\n\n\n\n\n\n\n\n### Paper figs\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# site-level drought threshold\nbas <- \"Flathead\"\nmonths <- c(7:9)\nbigG <- \"North Fork Flathead River NWIS\"\n\ndd <- dat_clean_join %>% filter(basin == bas, month %in% months, WaterYear == 2021) %>% mutate(site_name = factor(site_name, levels = rev(c(bigG, flatorder))))\ndd_sub <- dat_clean_sub %>% filter(basin == bas, month %in% months, WaterYear == 2021) %>% mutate(site_name = factor(site_name, levels = rev(c(bigG, flatorder))))\nmysites <- unlist(unique(dd_sub$site_name))\ndd <- dd %>% filter(site_name %in% mysites)\nmyrect <- dd %>% group_by(WaterYear) %>% summarize(mindate = min(date), maxdate = max(date)) %>% ungroup()\n\n\n# HEAT MAPS\nheat1 <- dd %>%\n  ggplot() +\n  geom_tile(aes(x = date, y = site_name, fill = drought_fix)) +\n  scale_fill_viridis(option = \"A\", direction = -1, discrete = TRUE, limits = mydroughtlevels) +\n  #geom_rect(data = myrect, aes(xmin = mindate, xmax = maxdate, ymin = length(mysites)-0.5, ymax = length(mysites)+0.5), \n  #          color = \"grey70\", fill = NA, size = 1.25) +\n  xlab(\"Date\") + ylab(\"Site\") +\n  theme_bw() + theme(axis.title = element_blank(), panel.background = element_rect(fill = 'grey90'),\n                     panel.grid.major = element_blank(), panel.grid.minor = element_blank(), \n                     axis.text = element_text(color = \"black\")) +\n  geom_line(data = data.frame(x = c(min(dd$date)-days(10), max(dd$date)+days(10)), y = rep(2:length(mysites), each = 2)-0.5), \n            aes(x = x, y = y, group = y), color = \"grey70\") +\n  coord_cartesian(xlim = c(min(dd$date), max(dd$date))) +\n  scale_y_discrete(expand = c(0,0), labels = rev(c(\"Ref.\", 1:13))) + \n  scale_x_date(expand = c(0,0), breaks = as.Date(c(\"2021-07-01\", \"2021-08-01\", \"2021-09-01\", \"2021-09-30\")), \n               labels = c(\"Jul\", \"Aug\", \"Sep\", \"Oct\")) +\n  guides(fill = guide_legend(title = \"Drought\\nthreshold (%)\"))\n\nheat2 <- dd_sub %>%\n  ggplot() +\n  geom_tile(aes(x = date, y = site_name, fill = drought_fix)) +\n  scale_fill_viridis(option = \"A\", direction = -1, discrete = TRUE, limits = mydroughtlevels) +\n  #geom_rect(data = myrect, aes(xmin = mindate, xmax = maxdate, ymin = length(mysites)-0.5, ymax = length(mysites)+0.5), \n  #          color = \"grey70\", fill = NA, size = 1.25) +\n  xlab(\"Date\") + ylab(\"Site\") +\n  theme_bw() + theme(axis.title = element_blank(), panel.background = element_rect(fill = 'grey90'),\n                     panel.grid.major = element_blank(), panel.grid.minor = element_blank(),\n                     axis.text = element_text(color = \"black\")) +\n  geom_line(data = data.frame(x = c(min(dd_sub$date)-days(10), max(dd_sub$date)+days(10)), y = rep(2:length(mysites), each = 2)-0.5), \n            aes(x = x, y = y, group = y), color = \"grey70\") +\n  coord_cartesian(xlim = c(min(dd_sub$date), max(dd_sub$date))) +\n  scale_y_discrete(expand = c(0,0), labels = rev(c(\"Ref.\", 1:13))) + \n  scale_x_date(expand = c(0,0), breaks = as.Date(c(\"2021-07-01\", \"2021-08-01\", \"2021-09-01\", \"2021-09-30\")), \n               labels = c(\"Jul\", \"Aug\", \"Sep\", \"Oct\")) +\n  guides(fill = guide_legend(title = \"Drought\\nthreshold (%)\"))\n\njpeg(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/Presentation figs/Heatmaps_Flathead_2021.jpg\", width = 4, height = 5, units = \"in\", res = 1000)\nggarrange(heat1, heat2, nrow = 2, common.legend = TRUE, legend = \"right\")\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n\n```{.r .cell-code}\n# SCATTERPLOTS\nscat1 <- defdur_ssn2 %>%\n  filter(designation == \"little\", ndays >= 87) %>%\n  group_by(basin, WaterYear) %>%\n  summarize(sddur = sd(duration_10_fix_prop),\n            rangedur = max(duration_10_fix)-min(duration_10_fix),\n            nsites = n()) %>%\n  ungroup() %>%\n  left_join(wateravail2 %>% select(basin, WaterYear, totalyield:tyz_sum_perc)) %>%\n  ggplot(aes(x = tyz_sum_perc, y = rangedur)) +\n  geom_smooth(method = \"lm\", color = \"black\", aes(weight = nsites)) +\n  geom_point(aes(fill = basin, size = nsites), shape = 21) +\n  scale_fill_manual(values = mycols) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.title = element_blank(), \n                     axis.text = element_text(color = \"black\")) + ylim(-10,100) +\n  guides(fill = guide_legend(title = \"Basin\", override.aes = list(size = 5), order = 1), \n         size = guide_legend(title = \"Number of sites\", order = 2))\n\nscat2 <- defdur_ssn_sub2 %>%\n  filter(designation == \"little\", ndays >= 87) %>%\n  group_by(basin, WaterYear) %>%\n  summarize(sddur = sd(duration_10_fix_prop),\n            rangedur = max(duration_10_fix)-min(duration_10_fix),\n            nsites = n()) %>%\n  ungroup() %>%\n  left_join(wateravail2 %>% select(basin, WaterYear, totalyield:tyz_sum_perc)) %>%\n  ggplot(aes(x = tyz_sum_perc, y = rangedur)) +\n  geom_smooth(method = \"lm\", color = \"black\", aes(weight = nsites)) +\n  geom_point(aes(fill = basin, size = nsites), shape = 21) +\n  scale_fill_manual(values = mycols) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.title = element_blank(), \n                     axis.text = element_text(color = \"black\")) + ylim(-10,100) +\n  guides(fill = guide_legend(title = \"Basin\", override.aes = list(size = 5), order = 1), \n         size = guide_legend(title = \"Number of sites\", order = 2))\n\njpeg(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/Presentation figs/DroughtScatter_all.jpg\", width = 4.5, height = 5, units = \"in\", res = 1000)\nggarrange(scat1, scat2, nrow = 2, common.legend = TRUE, legend = \"right\")\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n\n```{.r .cell-code}\n# REGRESSION PLOTS\ncolnums <- c(8:18)\neffecttib <- tibble(threshold = rep(NA, times = length(colnums)),\n                    int_est = rep(NA, times = length(colnums)),\n                    int_se = rep(NA, times = length(colnums)),\n                    slo_est = rep(NA, times = length(colnums)),\n                    slo_se = rep(NA, times = length(colnums)))\nfor (i in 1:length(colnums)) {\n  effecttib$threshold[i] <- parse_number(names(defdur_ssn2)[colnums[i]+2])\n  dd <- defdur_ssn2 %>%\n    filter(designation == \"little\", ndays >= 87) %>%\n    group_by(basin, WaterYear) %>%\n    summarize(n = n()) %>%\n    ungroup() %>%\n    left_join(defdur_ssn2 %>%\n                filter(designation == \"little\", ndays >= 87) %>%\n                group_by(basin, WaterYear) %>%\n                summarize_at(colnums[i], funs(min, max)) %>%\n                ungroup()) %>%\n    mutate(rangedur = max-min) %>%\n    left_join(wateravail2 %>% select(basin, WaterYear, tyz_sum_perc)) #%>%\n    #rename(sddur = 4)\n  mymod <- summary(lm(rangedur ~ tyz_sum_perc, data = dd, weights = n))\n  effecttib$int_est[i] <- mymod$coefficients[1,1]\n  effecttib$int_se[i] <- mymod$coefficients[1,2]\n  effecttib$slo_est[i] <- mymod$coefficients[2,1]\n  effecttib$slo_se[i] <- mymod$coefficients[2,2]\n}\n\n\ncolnums <- c(8:18)\neffecttib2 <- tibble(threshold = rep(NA, times = length(colnums)),\n                    int_est = rep(NA, times = length(colnums)),\n                    int_se = rep(NA, times = length(colnums)),\n                    slo_est = rep(NA, times = length(colnums)),\n                    slo_se = rep(NA, times = length(colnums)))\nfor (i in 1:length(colnums)) {\n  effecttib2$threshold[i] <- parse_number(names(defdur_ssn_sub2)[colnums[i]+2])\n  dd <- defdur_ssn_sub2 %>%\n    filter(designation == \"little\", ndays >= 87) %>%\n    group_by(basin, WaterYear) %>%\n    summarize(n = n()) %>%\n    ungroup() %>%\n    left_join(defdur_ssn_sub2 %>%\n                filter(designation == \"little\", ndays >= 87) %>%\n                group_by(basin, WaterYear) %>%\n                summarize_at(colnums[i], funs(min, max)) %>%\n                ungroup()) %>%\n    mutate(rangedur = max-min) %>%\n    left_join(wateravail2 %>% select(basin, WaterYear, tyz_sum_perc)) #%>%\n    #rename(sddur = 4)\n  mymod <- summary(lm(rangedur ~ tyz_sum_perc, data = dd, weights = n))\n  effecttib2$int_est[i] <- mymod$coefficients[1,1]\n  effecttib2$int_se[i] <- mymod$coefficients[1,2]\n  effecttib2$slo_est[i] <- mymod$coefficients[2,1]\n  effecttib2$slo_se[i] <- mymod$coefficients[2,2]\n}\n\n\nregr1 <- effecttib %>%\n  ggplot(aes(x = threshold, y = slo_est)) +\n  geom_abline(intercept = 0, slope = 0, linetype = \"dashed\") +\n  geom_line(color = \"grey\") +\n  geom_errorbar(aes(ymin = slo_est-slo_se, ymax = slo_est+slo_se), width = 1) +\n  geom_point(shape = 21, fill = \"white\") + \n  geom_point(data = effecttib %>% filter(threshold == 10), aes(x = threshold, y = slo_est), size = 2) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.title = element_blank(), axis.text = element_text(color = \"black\")) +\n  ylim(-0.82,0.22)\n\nregr2 <- effecttib2 %>%\n  ggplot(aes(x = threshold, y = slo_est)) +\n  geom_abline(intercept = 0, slope = 0, linetype = \"dashed\") +\n  geom_line(color = \"grey\") +\n  geom_errorbar(aes(ymin = slo_est-slo_se, ymax = slo_est+slo_se), width = 1) +\n  geom_point(shape = 21, fill = \"white\") + \n  geom_point(data = effecttib2 %>% filter(threshold == 10), aes(x = threshold, y = slo_est), size = 2) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.title = element_blank(), axis.text = element_text(color = \"black\")) +\n  ylim(-0.82,0.22)\n\njpeg(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/Presentation figs/DroughtEffect.jpg\", width = 2.75, height = 5, units = \"in\", res = 1000)\nggarrange(regr1, regr2, nrow = 2)\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\n## Presentation figs\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\njpeg(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/Presentation figs/EcoD_DroughtDiff_allsites.jpg\", width = 5, height = 4, units = \"in\", res = 1000)\nmycols <- brewer.pal(7, \"Set2\")[-2]\ndefdur_ssn_sub2 %>%\n  filter(designation == \"little\") %>%\n  mutate(logit_duration = log((duration_15_fix_prop+0.001)/(1-(duration_15_fix_prop+0.001)))) %>%\n  group_by(basin, WaterYear) %>%\n  summarize(sddur = sd(duration_15_fix_prop),\n            sddur_logit = sd(logit_duration),\n            nsites = n()) %>%\n  ungroup() %>%\n  left_join(wateravail2 %>% select(basin, WaterYear, totalyield:tyz_sum_perc)) %>%\n  ggplot(aes(x = tyz_sum_perc, y = sddur)) +\n  geom_abline(intercept = 0, slope = 0, linetype = \"dashed\") +\n  geom_smooth(method = \"lm\", color = \"black\", aes(weight = nsites)) +\n  #geom_smooth(method = \"glm\", formula = y+0.000000001~x, method.args = list(family = gaussian(link = 'log'))) +\n  geom_point(aes(fill = basin, size = nsites), shape = 21) +\n  #scale_fill_brewer(palette = \"Set2\") +\n  scale_fill_manual(values = mycols) +\n  ylab(\"Spatial variation in drought duration (SD)\") + xlab(\"Regional water availability (percentile)\") +\n  #facet_wrap(~basin) +\n  #annotate(\"text\", label = \"10th perc.\", x = Inf, y = Inf, hjust = 1, vjust = 1) +\n  theme_bw() + theme(panel.grid = element_blank()) +\n  guides(fill = guide_legend(title = \"Basin\", override.aes = list(size = 5)), size = guide_legend(title = \"Number of sites\"))\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\njpeg(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/Presentation figs/EcoD_DroughtDiff_fixed_allsites.jpg\", width = 5.5, height = 4, units = \"in\", res = 1000)\nmycols <- brewer.pal(7, \"Set2\")[-2]\ndefdur_ssn2 %>%\n  filter(designation == \"little\") %>%\n  group_by(basin, WaterYear) %>%\n  summarize(sddur = sd(duration_05_fix_prop),\n            nsites = n()) %>%\n  ungroup() %>%\n  left_join(wateravail2 %>% select(basin, WaterYear, totalyield:tyz_sum_perc)) %>%\n  ggplot(aes(x = tyz_sum_perc, y = sddur)) +\n  geom_abline(intercept = 0, slope = 0, linetype = \"dashed\") +\n  geom_smooth(method = \"lm\", color = \"black\", aes(weight = nsites)) +\n  geom_point(aes(fill = basin, size = nsites), shape = 21) +\n  # scale_fill_brewer(palette = \"Set2\") +\n  scale_fill_manual(values = mycols) +\n  ylab(\"Spatial variation in drought duration (SD)\") + xlab(\"Regional water availability (percentile)\") +\n  guides(fill = guide_legend(title = \"Basin\", override.aes = list(size = 5)), size = guide_legend(title = \"Number of sites\")) +\n  #facet_wrap(~basin) +\n  #annotate(\"text\", label = \"5th perc.\", x = Inf, y = Inf, hjust = 1, vjust = 1) +\n  theme_bw() + theme(panel.grid = element_blank())\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# site-level drought threshold\nbas <- \"Flathead\"\nmonths <- c(7:9)\nbigG <- \"North Fork Flathead River NWIS\"\n\ndd <- dat_clean_sub %>% filter(basin == bas, WaterYear %in% c(2021, 2022))\nmysites <- c(unique(unlist(dd %>% filter(site_name != bigG) %>% select(site_name))), bigG)\nmyrect <- dd %>% group_by(WaterYear) %>% summarize(mindate = min(date), maxdate = max(date)) %>% ungroup()\ndd %>%\n    ggplot() +\n    geom_tile(aes(x = date, y = factor(site_name, levels = (mysites)), fill = drought_fix)) +\n    scale_fill_viridis(option = \"A\", direction = -1, discrete = TRUE, limits = mydroughtlevels) +\n    geom_rect(data = myrect, aes(xmin = mindate, xmax = maxdate, ymin = length(mysites)-0.5, ymax = length(mysites)+0.5), \n              color = \"grey70\", fill = NA, size = 1.25) +\n    xlab(\"Date\") + ylab(\"Site\") +\n    #facet_wrap(~WaterYear, scales = \"free_x\") + \n    facet_wrap(~WaterYear, scales = \"free_x\") +\n    theme_bw() + theme(axis.title = element_blank()) +\n  guides(fill = guide_legend(title = \"Low flow\\nthreshold\"))\n```\n\n::: {.cell-output-display}\n![](LowFlow_files/figure-html/unnamed-chunk-96-1.png){width=672}\n:::\n\n```{.r .cell-code}\njpeg(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/Presentation figs/EcoD_DroughtTS_fixed_Flathead2021.jpg\", width = 5.5, height = 3.5, units = \"in\", res = 1000)\ndd <- dat_clean_join %>% filter(basin == bas | site_name == bigG, month %in% months, WaterYear %in% c(2021), site_name != \"CycloneCreekMiddle\") %>%\n  mutate(site_name = ifelse(site_name == \"North Fork Flathead River NWIS\", \"NF Flathead NWIS\", site_name))\nmysites <- c(unique(unlist(dd %>% filter(designation == \"big\") %>% select(site_name))),\n             unique(unlist(dd %>% filter(designation == \"little\") %>% select(site_name))))\nmyrect <- dd %>% group_by(WaterYear) %>% summarize(mindate = min(date), maxdate = max(date)) %>% ungroup()\ndd %>%\n  ggplot() +\n  geom_tile(aes(x = date, y = factor(site_name, levels = rev(mysites)), fill = drought_fix)) +\n  scale_fill_viridis(option = \"A\", direction = -1, discrete = TRUE, limits = mydroughtlevels) +\n  geom_rect(data = myrect, aes(xmin = mindate, xmax = maxdate, ymin = length(mysites)-0.5, ymax = length(mysites)+0.5), \n            color = \"grey70\", fill = NA, size = 1.25) +\n  xlab(\"Date\") + ylab(\"Site\") +\n  #facet_wrap(~WaterYear, scales = \"free_x\") + \n  #facet_wrap(~WaterYear, scales = \"free_x\") +\n  theme_bw() + theme(axis.title = element_blank()) +\n  guides(fill = guide_legend(title = \"Low flow\\nthreshold\"))\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n## Big plot\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# site-level drought threshold\nheatmapfun_site <- function(bas, months, bigG) {\n  dd <- dat_clean_sub %>% filter(basin == bas)\n  mysites <- c(unique(unlist(dd %>% filter(site_name != bigG) %>% select(site_name))), bigG)\n  myrect <- dd %>% group_by(WaterYear) %>% summarize(mindate = min(date), maxdate = max(date)) %>% ungroup()\n  p <- dd %>%\n    ggplot() +\n    geom_tile(aes(x = date, y = factor(site_name, levels = (mysites)), fill = drought_fix)) +\n    scale_fill_viridis(option = \"A\", direction = -1, discrete = TRUE, limits = mydroughtlevels) +\n    geom_rect(data = myrect, aes(xmin = mindate, xmax = maxdate, ymin = length(mysites)-0.5, ymax = length(mysites)+0.5), \n              color = \"grey70\", fill = NA, size = 1.25) +\n    xlab(\"Date\") + ylab(\"Site\") +\n    #facet_wrap(~WaterYear, scales = \"free_x\") + \n    facet_wrap2(~WaterYear, scales = \"free_x\", nrow = 2, ncol = 3, trim_blank = FALSE) +\n    theme_bw() + theme(axis.title = element_blank())\nreturn(p)\n}\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\n\n\n\n## Model\n\nHere I tried to model drought duration using a hierarchical binomial model, then estimate the effect of regional water availability on spatial variation drought duration within headwater basins. But most of the parameters do not converge (most notable, the spatial variation parameter), which is probably a result of so few data points (years) per basin.\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"model {\n\n##--- LIKELIHOOD ---------------------------------------------------##\n\n# for (k in 1:nyrs) {\n#   for (j in 1:nsites) {\n#     y[j,k] ~ dbin(p[j,k], N[j,k])\n#     logit(p[j,k]) <- alpha[site_basin[j],k] + u[j,k]\n#     u[j,k] ~ dnorm(basin_effect[site_basin[j],k], pow(sigma_spatial[site_basin[j]], -2))\n#   }\n#   for (b in 1:nbasin) {\n#     log(sigma_spatial[b]) <- beta0 + beta1*water_avail[b,k]\n#   }\n# }\n\n\nfor (i in 1:nobs) {\n  drought_days[i] ~ dbin(p[i], n_days[i])\n  logit(p[i]) <- alpha[basin[i], year[i]] + u[i]\n  u[i] ~ dnorm(0, pow(sigma_spatial[basin[i], year[i]], -2))\n}\n\nfor (b in 1:nbasins) {\n  for (y in 1:nyears) {\n    sigma_spatial[b,y] <- exp(beta0[b] + beta1[b] * regional_water[b,y])\n  }\n}\n\n\nfor (b in 1:nbasins) {\n  beta0[b] ~ dnorm(mu_beta0, pow(100, -2))\n  beta1[b] ~ dnorm(mu_beta1, pow(100, -2))\n  for (y in 1:nyears) {\n    alpha[b,y] ~ dnorm(mu_alpha, pow(100, -2))\n  }\n}\n\nmu_alpha ~ dnorm(0, pow(100, -2))\nmu_beta0 ~ dnorm(0, pow(100, -2))\nmu_beta1 ~ dnorm(0, pow(100, -2))\n\n\n\n##--- PRIORS --------------------------------------------------------##\n\n# for (b in 1:nbasin) {\n#   alpha[b] ~ dnorm(0, pow(10, -2))\n#   \n#   for (k in 1:nyrs) {\n#     basin_effect[b,k] ~ dnorm(0, pow(100, -2))\n#   }\n# }\n\n\n##--- DERIVED VALUES ------------------------------------------------##\n\n\n\n\n}\", file = \"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/LowFlowModel.txt\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndefdur_ssn_sub2_sub <- defdur_ssn_sub2 %>%\n  filter(designation == \"little\",\n         basin %in% c(\"West Brook\", \"Staunton River\", \"Snake River\", \"Donner Blitzen\")) %>% \n  select(basin, subbasin, site_name, WaterYear, ndays, duration_10_fix) %>%\n  arrange(basin, WaterYear, site_name) %>%\n  mutate(basin_code = as.numeric(as.factor(basin)),\n         WaterYear_code = as.numeric(as.factor(WaterYear)))\n\nregional_water <- wateravail %>% \n  filter(basin %in% unique(defdur_ssn_sub2_sub$basin),\n         WaterYear %in% unique(defdur_ssn_sub2_sub$WaterYear)) %>%\n  select(basin, WaterYear, totalyield_sum_z) %>%\n  spread(key = WaterYear, value = totalyield_sum_z)\nregional_water_mat <- regional_water[,-1]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# --- Prepare Data for JAGS ---\n\njags.data <- list(\n  \"nobs\" = dim(defdur_ssn_sub2_sub)[1],\n  \"nbasins\" = length(unique(defdur_ssn_sub2_sub$basin)),\n  \"nyears\" = length(unique(defdur_ssn_sub2_sub$WaterYear)),\n  \"drought_days\" = defdur_ssn_sub2_sub$duration_10_fix,\n  \"n_days\" = defdur_ssn_sub2_sub$ndays,\n  \"basin\" = defdur_ssn_sub2_sub$basin_code,\n  \"year\" = defdur_ssn_sub2_sub$WaterYear_code,\n  \"regional_water\" = regional_water_mat\n)\n\n# parameters to monitor\njags.params <- c(\"mu_alpha\", \"mu_beta0\", \"mu_beta1\", \"alpha\", \"beta0\", \"beta1\", \"sigma_spatial\", \"u\", \"p\")\n\n# run in jags\nmod_0 <- jags(data = jags.data, parameters.to.save = jags.params,\n              model.file = \"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/LowFlowModel.txt\",\n              n.chains = 3, n.thin = 50, n.burnin = 2000, n.iter = 10000, DIC = FALSE)\n```\n:::\n\n\n\n\n\n\nGet MCMC samples and summary\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop_mod <- mod_0\n# generate MCMC samples and store as an array\nmodelout <- top_mod$BUGSoutput\nMcmcList <- vector(\"list\", length = dim(modelout$sims.array)[2])\nfor(i in 1:length(McmcList)) { McmcList[[i]] = as.mcmc(modelout$sims.array[,i,]) }\n# rbind MCMC samples from 10 chains \nMcmcdat <- rbind(McmcList[[1]], McmcList[[2]], McmcList[[3]])\nparam.summary <- modelout$summary\nhead(param.summary)\n```\n:::\n\n\n\n\n\n\nFor global parameters and hyperparameters only...\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nMCMCtrace(mod_0, ind = TRUE, params = c(\"u\"), pdf = FALSE)\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}